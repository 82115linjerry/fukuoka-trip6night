<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- æ¨™é¡Œè¨­å®š -->
    <title>æ—ç³–ç³–çš„ç¦å²¡å†¬æ—¥ä¹‹æ—… â„ï¸</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FCA5A5">

    <!-- Icons (æ›´å¯æ„›çš„é…è‰²) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' ry='120' fill='%23FCA5A5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' ry='120' fill='%23FCA5A5'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href='data:application/manifest+json,{"name":"æ—ç³–ç³–çš„ç¦å²¡è¡Œ","short_name":"ç¦å²¡ä¹‹æ—…","display":"standalone","start_url":".","background_color":"#FFF7ED","theme_color":"#FCA5A5","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 rx=%27120%27 ry=%27120%27 fill=%27%23FCA5A5%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27central%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%27300%27 font-family=%27sans-serif%27 font-weight=%27bold%27%3Eç³–%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}'>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* æŸ”å’Œå­—é«”èˆ‡èƒŒæ™¯ */
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #FFF7ED; /* æš–ç±³è‰²èƒŒæ™¯ */
            color: #4B5563; /* æŸ”å’Œçš„æ·±ç°è‰²æ–‡å­— */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Map Styling */
        #map { height: 100%; width: 100%; border-radius: 1.5rem; z-index: 0; border: 4px solid white; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .leaflet-popup-content-wrapper { border-radius: 16px; font-family: system-ui; padding: 0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 16px; }
        .leaflet-tooltip { font-weight: bold; border-radius: 8px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-size: 12px; padding: 6px 10px; color: #4B5563; background: rgba(255, 255, 255, 0.95); }
        
        /* FIX: Ensure divIcon markers are visible */
        .custom-pin, .user-pin { display: block !important; width: 16px !important; height: 16px !important; }

        /* Animations */
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* Soft Gradient Text */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(to right, #F472B6, #FB923C);
        }
    </style>
</head>
<body class="flex justify-center h-[100dvh] overflow-hidden bg-[#FFF7ED]">

    <div id="root" class="w-full h-full max-w-md bg-[#FFF7ED] shadow-2xl overflow-hidden relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Adjusted for softer look) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
                CreditCard: <><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></>,
                Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
                ShieldAlert: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                ChevronUp: <polyline points="18 15 12 9 6 15"/>,
                Navigation: <polygon points="3 11 22 2 13 21 11 13 3 11"/>,
                Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
                ShoppingBag: <><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
                Train: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><line x1="2" y1="17" x2="22" y2="17"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                Car: <path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a1 1 0 0 0-.8.4L1.74 11l-5.16.85a1 1 0 0 0-.84.99V16h3m14 0v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2m-8 0v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-2"/>,
                Refresh: <><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                Type: <><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>,
                Percent: <><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></>,
                Plane: <path d="M2 12h5l8 5 9-9-9-9-8 5H2v8z"/>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
                Sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
                Camera: <><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>,
                Wifi: <path d="M5 12.55a11 11 0 0 1 14.08 0M1.42 9a16 16 0 0 1 21.16 0M8.53 16.11a6 6 0 0 1 6.95 0M12 20h.01"/>,
                Check: <polyline points="20 6 9 17 4 12"/>,
                AlertCircle: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- GLOBAL CONSTANTS ---
        const initialTripData = {
          itinerary: [
            {
              day: 1, date: "12/09 (é€±äºŒ)", theme: "åˆæŠµç¦åœ° âœˆï¸",
              tasks: [
                { id: 't1-1', time: "11:00-13:30", title: "æ¡ƒåœ’æ©Ÿå ´ -> ç¦å²¡æ©Ÿå ´ (IT720)", type: "transport", lat: 33.5859, lng: 130.4507, note: "APPè‡ªåŠ©å ±åˆ°èˆ‡è¨—é‹ï¼Œé¿é–‹äººæ½®ã€‚" },
                { id: 't1-2', time: "16:55-18:00", title: "å…¥å¢ƒå¯©æŸ¥ & é ˜è¡Œæ", type: "transport", note: "é—œéµï¼šç«‹å³é–‹å•Ÿ VJW æˆªåœ–ï¼Œä¿æŒéšŠå½¢ã€‚" },
                { id: 't1-3', time: "18:00-18:45", title: "æ©Ÿå ´ -> é£¯åº— (è¨ˆç¨‹è»Š)", type: "transport", lat: 33.5861, lng: 130.4190, note: "å¾ A3 å‡ºå£æ­ä¹˜ï¼Œè»Šè³‡ç´„ Â¥2,500ã€‚ä¿ç•™é«”åŠ›ã€‚" },
                { id: 't1-4', time: "19:00-20:00", title: "Check-in & ä¼‘æ¯", type: "transport", note: "é•·è¼©ä¼‘æ¯ï¼Œç†Ÿæ‚‰é£¯åº—è¨­å‚™ã€‚" },
                { id: 't1-5', time: "20:00-21:30", title: "æ™šé¤ï¼šåšå¤šç¥‡åœ’é‰„ãªã¹", type: "food", map: "åšå¤šç¥‡åœ’é‰„ãªã¹", lat: 33.5912, lng: 130.4162, note: "æ’éšŠååº—ã€‚å‚™æ¡ˆBï¼šãŸã‚“ã‚„HAKATA (ç‰›èˆŒå®šé£Ÿ)ã€‚" },
                { id: 't1-6', time: "21:30+", title: "å¤œé–“æ¡è²·ï¼šMaxValu", type: "shopping", map: "MaxValu Express Hakata Ekimae", lat: 33.5855, lng: 130.4178, note: "å»ºç«‹åˆå§‹åº«å­˜(æ°´ã€æ°´æœã€æ—©é¤)ã€‚" }
              ]
            },
            {
              day: 2, date: "12/10 (é€±ä¸‰)", theme: "æ–°èˆŠäº¤è â›©ï¸",
              tasks: [
                { id: 't2-1', time: "08:00-09:30", title: "æ—©é¤ï¼šDacomecca", type: "food", map: "Dacomecca", lat: 33.5895, lng: 130.4222, note: "æ’éšŠç‹è€…ï¼Œå»ºè­°å¹´è¼•æˆå“¡å…ˆå»æ’éšŠã€‚" },
                { id: 't2-2', time: "09:30-12:00", title: "æ«›ç”°ç¥ç¤¾ & å·ç«¯é€š", type: "sightseeing", map: "Kushida Shrine", lat: 33.5930, lng: 130.4106, note: "æ„Ÿå—åšå¤šæ–‡åŒ–æºé ­ã€‚" },
                { id: 't2-3', time: "10:15", title: "Full Full Hakata", type: "food", map: "Full Full Hakata", lat: 33.5942, lng: 130.4140, note: "è³¼è²·æ‹›ç‰Œæ˜å¤ªå­æ³•åœ‹éºµåŒ…ã€‚" },
                { id: 't2-4', time: "12:00-13:30", title: "åˆé¤ï¼šé°»é­šå››ä»£ç›®èŠå·", type: "food", map: "é°»é­šå››ä»£ç›®èŠå· ä¸­æ´²æ˜¥å‰åº—", lat: 33.5905, lng: 130.4075, note: "å‰å¡šé°»é­šå±‹å…¬ä¼‘ï¼Œæ”¹åƒé€™å®¶ (ä¸­æ´²æ˜¥å‰åº—)ã€‚" },
                { id: 't2-5', time: "13:30-15:00", title: "(é¸æ“‡æ€§) COCO'S å¤§æ©‹åº—", type: "food", map: "COCO'S Ohashi", note: "è‹¥é«”åŠ›ä¸è¶³å»ºè­°å–æ¶ˆï¼Œç›´æ¥å‰å¾€ Lalaportã€‚" },
                { id: 't2-6', time: "15:00-17:30", title: "Lalaport ç¦å²¡", type: "sightseeing", map: "LaLaport Fukuoka", lat: 33.5504, lng: 130.4463, note: "æœè– 1:1 é‹¼å½ˆç«‹åƒ (æ•´é»æœ‰æ¼”å‡º)ã€‚" },
                { id: 't2-7', time: "17:30-19:30", title: "æ™šé¤ï¼šç‡’è‚‰ å¤§æ±åœ’ æœ¬åº—", type: "food", map: "Daitoen Honten", lat: 33.5935, lng: 130.4128, note: "å¿…é ˆé ç´„ã€‚å‚™æ¡ˆBï¼šåšå¤šè¯å‘³é³¥ã€‚" },
                { id: 't2-8', time: "20:30+", title: "åšå¤šé‹æ²³åŸ", type: "sightseeing", map: "Canal City Hakata", lat: 33.5898, lng: 130.4108, note: "å¤œé–“æ°´èˆç§€ã€‚" }
              ]
            },
            {
              day: 3, date: "12/11 (é€±å››)", theme: "å¤ªå®°åºœç¦ªæ„ ğŸŒ¸",
              tasks: [
                { id: 't3-1', time: "10:00-11:00", title: "ç§»å‹•ï¼šåšå¤š -> å¤ªå®°åºœ", type: "transport", map: "Hakata Bus Terminal", note: "åšå¤šå·´å£«ç¸½ç«™ 1F 11è™Ÿæœˆå°æ­ä¹˜ã€Œæ—…äººã€è™Ÿã€‚" },
                { id: 't3-2', time: "11:00-14:30", title: "å¤ªå®°åºœç²¾è¯éŠ", type: "sightseeing", map: "Dazaifu Tenmangu", lat: 33.5215, lng: 130.5349, note: "è¡¨åƒé“æ¢…æé¤…ã€æ˜Ÿå·´å…‹ã€å¤©æ»¿å®®é£›æ¢…é¤¨ã€‚" },
                { id: 't3-3', time: "12:30", title: "åˆé¤ï¼šä¸€è˜­æ‹‰éºµ å¤ªå®°åºœåº—", type: "food", map: "Ichiran Dazaifu", lat: 33.5192, lng: 130.5317, note: "ç‰¹è‰²ï¼šåˆæ ¼äº”è§’ç¢—ã€‚" },
                { id: 't3-4', time: "14:30-16:00", title: "å…‰æ˜ç¦ªå¯º", type: "sightseeing", map: "Komyozenji", lat: 33.5186, lng: 130.5344, note: "æ¯å±±æ°´åº­åœ’ã€‚æ‹œè§€æ–™Â¥300åƒ…æ”¶ç¾é‡‘ã€‚" },
                { id: 't3-5', time: "17:00-19:00", title: "Pain Stock å¤©ç¥", type: "shopping", map: "stock", lat: 33.5900, lng: 130.4035, note: "å¤©ç¥ä¸­å¤®å…¬åœ’åº—ï¼Œå“åšéºµåŒ…èˆ‡å’–å•¡ã€‚" },
                { id: 't3-6', time: "19:00-21:00", title: "æ™šé¤ï¼šéºµå±‹å…¼è™", type: "food", map: "Menya Kanetora Tenjin", lat: 33.5886, lng: 130.3995, note: "æ²¾éºµååº—ã€‚å‚™æ¡ˆBï¼šå¤§ç ²æ‹‰éºµã€‚" }
              ]
            },
            {
              day: 4, date: "12/12 (é€±äº”)", theme: "æ¸¯éƒ½æ‡·èˆŠ âš“",
              tasks: [
                { id: 't4-1', time: "09:00-10:20", title: "ç§»å‹•ï¼šåšå¤š -> é–€å¸æ¸¯", type: "transport", map: "Hakata Station", note: "é€Ÿåº¦æˆ°è¡“ï¼šæ–°å¹¹ç·šè‡³å°å€‰ï¼Œå†è½‰ä¹˜ JR è‡³é–€å¸æ¸¯ã€‚" },
                { id: 't4-2', time: "10:30-12:30", title: "é–€å¸æ¸¯æ‡·èˆŠå€æ•£ç­–", type: "sightseeing", map: "Mojiko Retro", lat: 33.9446, lng: 130.9633, note: "èˆŠä¸‰äº•ä¿±æ¨‚éƒ¨ã€è—ç¿¼é–€å¸åŠæ©‹ã€‚" },
                { id: 't4-3', time: "12:30-13:30", title: "åˆé¤ï¼šä¼½å“©æœ¬èˆ–", type: "food", map: "Curry Honpo Mojiko", lat: 33.9458, lng: 130.9615, note: "ç‡’å’–å“©åç‰©ï¼Œæ¨è–¦çª—é‚Šåº§ä½ã€‚" },
                { id: 't4-4', time: "13:30-15:30", title: "ä¸‹åˆèŒ¶ & é«”é©—", type: "sightseeing", map: "Karato Market", note: "æ–¹æ¡ˆA: é–€å¸æ¸¯å¸ƒä¸ / æ–¹æ¡ˆB: è¯çµ¡èˆ¹è‡³å”æˆ¶å¸‚å ´+æµ·åº•éš§é“ã€‚" },
                { id: 't4-5', time: "17:00-19:00", title: "ç§»å‹•ï¼šå°å€‰ -> åšå¤š", type: "transport", note: "è¿”å›åšå¤šæ™šé¤ã€‚" },
                { id: 't4-6', time: "19:00+", title: "æ™šé¤ï¼šä½†é¦¬å±‹ / å°æ—é¤Šé›", type: "food", map: "Hakata Station", lat: 33.5902, lng: 130.4207, note: "å£½å–œç‡’åƒåˆ°é£½ æˆ– æ—¥å¼å±…é…’å±‹ã€‚" }
              ]
            },
            {
              day: 5, date: "12/13 (é€±å…­)", theme: "åšå¤šç¾é£Ÿç²¾é«“ ğŸœ",
              tasks: [
                { id: 't5-1', time: "08:30-10:00", title: "æ—©é¤ï¼šé£Ÿå ‚ ãŠã‚ã‚“", type: "food", map: "Shokudo Owan", lat: 33.5925, lng: 130.4135, note: "ç²¾ç·»æ—¥å¼å‚³çµ±æœé£Ÿã€‚" },
                { id: 't5-2', time: "10:00-12:00", title: "å¤©ç¥åœ°ä¸‹è¡—", type: "shopping", map: "Tenjin Underground Shopping Center", note: "è³¼ç‰©èˆ‡ä¼´æ‰‹ç¦®æ¡è²·ã€‚" },
                { id: 't5-3', time: "12:00-13:30", title: "åˆé¤ï¼šã¨ã‚“ã‹ã¤ã‚ã‹è‘‰", type: "food", map: "Tonkatsu Wakaba", lat: 33.5938, lng: 130.4032, note: "ç‚¸è±¬æ’ã€‚æ’éšŠå…‡çŒ›ï¼Œå»ºè­° 11:15 å‰æŠµé”ã€‚" },
                { id: 't5-4', time: "15:00-17:00", title: "åšå¤šé‹æ²³åŸ", type: "sightseeing", map: "Canal City Hakata", lat: 33.5898, lng: 130.4108, note: "è£œå®Œè³¼ç‰©è¡Œç¨‹ï¼Œè§€è³å™´æ°´ç§€ã€‚" },
                { id: 't5-5', time: "17:30-19:00", title: "æ™šé¤ï¼šè¯å‘³é³¥ / å‰ç”°å±‹", type: "food", map: "Hakata Hanamidori", lat: 33.5935, lng: 130.4110, note: "åˆ†çµ„è¡Œå‹•ï¼šæ¸…æ·¡æ°´ç‚Šé›é‹ vs æ¿ƒéƒç‰›è…¸é‹ã€‚éœ€é ç´„ã€‚" }
              ]
            },
            {
              day: 6, date: "12/14 (é€±æ—¥)", theme: "ç¦å²¡ç”Ÿæ´»å…‰è­œ ğŸ",
              tasks: [
                { id: 't6-1', time: "09:00-10:30", title: "Amam Dacotan", type: "food", map: "Amam Dacotan", lat: 33.5755, lng: 130.3768, note: "å…¨æ—¥æœ¬è©±é¡Œåº¦æœ€é«˜ã€‚å‚™æ¡ˆï¼šMatsu Panã€‚" },
                { id: 't6-2', time: "10:30-13:00", title: "å¤§æ¿ å…¬åœ’ & ç¾è¡“é¤¨", type: "sightseeing", map: "Ohori Park", lat: 33.5865, lng: 130.3763, note: "æ¹–ç•”äº«ç”¨éºµåŒ…ï¼Œæ¬£è³è‰é–“å½Œç”Ÿå—ç“œã€‚" },
                { id: 't6-3', time: "14:00-15:00", title: "åˆé¤ï¼šé­šå¿ ", type: "food", map: "Uochu", lat: 33.5835, lng: 130.3955, note: "é«˜ç´šé®®é­šåº—ç›´ç‡Ÿï¼ŒCPå€¼æ¥µé«˜æµ·é®®å®šé£Ÿã€‚" },
                { id: 't6-4', time: "15:00-16:30", title: "è—¥é™¢é¸ç‰© & Coffee County", type: "shopping", map: "Bãƒ»Bãƒ»B POTTERS", note: "ç”Ÿæ´»é›œè²¨æ•£ç­–ã€‚" },
                { id: 't6-5', time: "17:00-18:30", title: "ç¦å²¡å¡”", type: "sightseeing", map: "Fukuoka Tower", lat: 33.5933, lng: 130.3515, note: "èœ‚æ¨‚é¥…é ­ï¼Œæ¬£è³ç™¾é“æµ·æ¿±å¤œæ™¯ã€‚" },
                { id: 't6-6', time: "19:00+", title: "æ™šé¤ï¼šå°æ—é¤Šé›", type: "food", map: "Kobayashi Youkei Nishijin", lat: 33.5828, lng: 130.3555, note: "åœ¨åœ°äººå–œæ„›çš„å±…é…’å±‹ã€‚" }
              ]
            },
            {
              day: 7, date: "12/15 (é€±ä¸€)", theme: "å®Œç¾æ­¸é€” ğŸ¡",
              tasks: [
                { id: 't7-1', time: "09:00-11:00", title: "é€€æˆ¿ & è¡Œæå¯„æ”¾", type: "transport", note: "é£¯åº—æ«ƒå°å¯„æ”¾è¡Œæã€‚" },
                { id: 't7-2', time: "11:00-13:30", title: "åšå¤šç«™æœ€å¾Œè¡åˆº", type: "shopping", map: "Hakata Hankyu", lat: 33.5895, lng: 130.4205, note: "é˜ªæ€¥B1/AMUã€‚å¿…è²·ï¼šç¦ç ‚å±‹ã€åŠªåŠªé›ã€‚" },
                { id: 't7-3', time: "12:00-13:00", title: "åˆé¤ï¼šåšå¤šéºµè¡—é“", type: "food", map: "Hakata Noodle Street", note: "æœ€å¾Œä¸€ç¢—æ‹‰éºµ (Shin-Shin/æµ·é³´)ã€‚" },
                { id: 't7-4', time: "14:00-15:00", title: "å‰å¾€æ©Ÿå ´", type: "transport", note: "å›é£¯åº—å–è¡Œæï¼Œæ­è¨ˆç¨‹è»Šç›´é”åœ‹éš›ç·šèˆªå»ˆã€‚" },
                { id: 't7-5', time: "15:00-15:15", title: "æŠµé”ç¦å²¡æ©Ÿå ´", type: "transport", map: "Fukuoka Airport International Terminal", lat: 33.5859, lng: 130.4507, note: "å‹™å¿…ææ—©ï¼Œå®‰æª¢æ’éšŠé•·ã€‚" },
                { id: 't7-6', time: "15:15-17:55", title: "å‡ºå¢ƒç¨‹åº & ç™»æ©Ÿ (IT721)", type: "transport", note: "17:55 èµ·é£›ã€‚å¹³å®‰æ­¸è³¦ã€‚" }
              ]
            }
          ]
        };

        const initialChecklist = [
          { id: 'c1', text: 'Visit Japan Web QR Code', done: false, cat: 'document' },
          { id: 'c3', text: 'è­·ç…§ (æ•ˆæœŸç¢ºèª)', done: false, cat: 'document' },
          { id: 'c10', text: 'ç¾é‡‘ (æ¯äººç´„ Â¥50,000)', done: false, cat: 'money' },
          { id: 'c12', text: 'ICå¡ (Suica/ICOCA)', done: false, cat: 'money' },
          { id: 'c14', text: 'è¡Œå‹•é›»æº & å……é›»ç·š', done: false, cat: 'other' }
        ];

        // --- COMPONENTS ---

        const MapTab = ({ itinerary }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const markersGroupRef = useRef(null);
            const [status, setStatus] = useState("é»æ“Šåœ°åœ–å¯æ–°å¢æ¨™è¨˜");
            const [userMarkers, setUserMarkers] = useState(() => JSON.parse(localStorage.getItem('fukuoka_user_markers')) || []);
            const [isAdding, setIsAdding] = useState(false);
            const [newMarkerPos, setNewMarkerPos] = useState(null);
            const [newMarkerName, setNewMarkerName] = useState('');
            const [newMarkerType, setNewMarkerType] = useState('food');

            useEffect(() => { localStorage.setItem('fukuoka_user_markers', JSON.stringify(userMarkers)); }, [userMarkers]);

            // Attach delete function to window safely
            useEffect(() => {
                window.fukuokaDeleteMarker = (id) => {
                    if(window.confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) {
                        setUserMarkers(prev => prev.filter(m => m.id !== id));
                    }
                };
                return () => { delete window.fukuokaDeleteMarker; };
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current && mapContainerRef.current) {
                    mapInstanceRef.current = L.map(mapContainerRef.current).setView([33.5902, 130.4207], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);

                    mapInstanceRef.current.on('click', (e) => {
                        setNewMarkerPos(e.latlng);
                        setIsAdding(true);
                    });
                    
                    markersGroupRef.current = L.layerGroup().addTo(mapInstanceRef.current);
                }

                const map = mapInstanceRef.current;
                const markersLayer = markersGroupRef.current;

                if (markersLayer) markersLayer.clearLayers();

                const addMarkerToMap = (lat, lng, title, type, isUser = false, id = null) => {
                    let color = '#22C55E'; // Green
                    if (type === 'food') color = '#F97316'; // Orange
                    if (type === 'sightseeing') color = '#3B82F6'; // Blue
                    if (type === 'shopping') color = '#EC4899'; // Pink
                    
                    const borderStyle = isUser ? 'border: 2px dashed white;' : 'border: 2px solid white;';
                    const markerHtml = `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; ${borderStyle} box-shadow: 0 3px 6px rgba(0,0,0,0.3);"></div>`;
                    
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: markerHtml,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -10],
                        tooltipAnchor: [8, -4] 
                    });
                    
                    const marker = L.marker([lat, lng], { icon }).addTo(markersLayer);
                    
                    marker.bindTooltip(title, { 
                        permanent: false, 
                        direction: 'top',
                        offset: [0, -12],
                        opacity: 0.9
                    });

                    const googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`;
                    
                    let popupContent = `
                        <div style="text-align:center; min-width: 120px;">
                            <div style="font-weight:bold; color:#4B5563; margin-bottom:8px; font-size:14px;">${title}</div>
                            <a href="${googleMapLink}" target="_blank" style="background-color:#60A5FA; color:white; padding:6px 16px; border-radius:99px; text-decoration:none; font-size:12px; font-weight:bold; display:inline-block; box-shadow: 0 2px 5px rgba(96,165,250,0.4);">å°èˆª GO ></a>
                    `;

                    if (isUser) {
                        popupContent += `<div style="margin-top:12px; border-top:1px solid #F3F4F6; padding-top:8px;"><button onclick="window.fukuokaDeleteMarker(${id})" style="color:#F87171; font-size:12px; border:none; background:none; text-decoration:underline; cursor:pointer; font-weight:bold;">åˆªé™¤æ­¤æ¨™è¨˜</button></div>`;
                    }
                    
                    popupContent += `</div>`;
                    marker.bindPopup(popupContent);
                };

                itinerary.forEach(day => {
                    day.tasks.forEach(task => {
                        if (task.lat && task.lng) {
                            addMarkerToMap(task.lat, task.lng, task.title, task.type);
                        }
                    });
                });

                userMarkers.forEach(m => {
                    addMarkerToMap(m.lat, m.lng, m.title, m.type, true, m.id);
                });

                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if (map) {
                                if (!userMarkerRef.current) {
                                    const userIcon = L.divIcon({
                                        className: 'user-pin',
                                        html: "<div style='background-color:#3B82F6; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow: 0 0 0 6px rgba(59,130,246,0.3);'></div>",
                                        iconSize: [28, 28],
                                        iconAnchor: [14, 14]
                                    });
                                    userMarkerRef.current = L.marker([latitude, longitude], {icon: userIcon, zIndexOffset: 1000}).addTo(map);
                                } else {
                                    userMarkerRef.current.setLatLng([latitude, longitude]);
                                }
                            }
                        },
                        (error) => { console.log("GPS Error", error); },
                        { enableHighAccuracy: true }
                    );
                }
            }, [itinerary, userMarkers]); 

            const confirmAddMarker = () => {
                if (!newMarkerName || !newMarkerPos) return;
                const newMarker = {
                    id: Date.now(),
                    lat: newMarkerPos.lat,
                    lng: newMarkerPos.lng,
                    title: newMarkerName,
                    type: newMarkerType
                };
                setUserMarkers([...userMarkers, newMarker]);
                setIsAdding(false);
                setNewMarkerName('');
            };

            return (
                <div className="h-full flex flex-col bg-[#FFF7ED] relative">
                    {/* Instructions Overlay */}
                    <div className="absolute top-4 left-4 right-4 z-[400] bg-white/90 backdrop-blur-md px-4 py-3 rounded-2xl shadow-lg border border-orange-100 flex justify-between items-center">
                        <span className="text-xs font-bold text-slate-600">ğŸ‘† é»æ“Šåœ°åœ–ï¼šå…ˆåµå¯Ÿ</span>
                        <div className="flex gap-2 text-[10px] font-bold text-slate-500">
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-400"></span>é£Ÿ</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-400"></span>ç©</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-400"></span>è³¼</span>
                        </div>
                    </div>
                    
                    {/* Add Marker Modal (Recon Mode) */}
                    {isAdding && (
                        <div className="absolute inset-0 z-[500] bg-black/20 flex items-center justify-center p-4">
                            <div className="bg-white p-6 rounded-3xl shadow-2xl w-full max-w-xs animate-bounce-in">
                                <h3 className="font-bold text-slate-800 mb-1 text-lg">ğŸ“ åµå¯Ÿæ–°åœ°é»</h3>
                                <p className="text-xs text-slate-400 mb-4">åº§æ¨™: {newMarkerPos.lat.toFixed(4)}, {newMarkerPos.lng.toFixed(4)}</p>
                                
                                <a 
                                    href={`https://www.google.com/maps/search/?api=1&query=${newMarkerPos.lat},${newMarkerPos.lng}`}
                                    target="_blank"
                                    className="block w-full text-center py-3 mb-5 bg-blue-50 text-blue-600 rounded-xl text-sm font-bold border border-blue-100 hover:bg-blue-100 transition"
                                >
                                    ğŸ” åœ¨ Google Maps ç¢ºèª
                                </a>

                                <div className="border-t border-slate-100 pt-4">
                                    <label className="text-xs font-bold text-slate-400 block mb-2">ç¢ºèªè¦æ–°å¢å—ï¼Ÿè«‹è¼¸å…¥åç¨±ï¼š</label>
                                    <input 
                                        placeholder="ä¾‹å¦‚ï¼šå¥½åƒçš„æ‹‰éºµ" 
                                        className="w-full p-3 mb-4 border border-slate-200 rounded-xl text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-100 outline-none transition"
                                        value={newMarkerName}
                                        onChange={e => setNewMarkerName(e.target.value)}
                                        autoFocus
                                    />
                                    <div className="flex gap-2 mb-4">
                                        {['food', 'sightseeing', 'shopping'].map(t => (
                                            <button 
                                                key={t}
                                                onClick={() => setNewMarkerType(t)}
                                                className={`flex-1 py-2 rounded-xl text-xs font-bold capitalize border-2 transition ${newMarkerType === t ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-400 border-slate-100'}`}
                                            >
                                                {t === 'food' ? 'é£Ÿ' : t === 'sightseeing' ? 'ç©' : 'è³¼'}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-3">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl text-sm font-bold">å–æ¶ˆ</button>
                                        <button onClick={confirmAddMarker} className="flex-1 py-3 bg-gradient-to-r from-blue-400 to-blue-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-blue-200">ç¢ºèªæ–°å¢</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div id="map" ref={mapContainerRef} className="flex-1 w-full h-full z-0"></div>
                </div>
            );
        };

        const HomeTab = ({ leaderInfo, setLeaderInfo, setActiveTab, apiKey, setApiKey }) => {
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [appTitle, setAppTitle] = useState(() => localStorage.getItem('fukuoka_app_title') || "æ—ç³–ç³–çš„å¥´éš¸åƒåƒå–å–ç¦å²¡è¡Œ");
            const [isEditingLeader, setIsEditingLeader] = useState(false);
            const [tempLeader, setTempLeader] = useState(leaderInfo);
            const [tempKey, setTempKey] = useState(apiKey);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(false);
            const [weatherError, setWeatherError] = useState(null);

            useEffect(() => { setTempLeader(leaderInfo); }, [leaderInfo]);

            const now = new Date();
            const outboundDate = new Date("2024-12-09T13:30:00+09:00");
            const inboundDate = new Date("2024-12-15T17:55:00+09:00");
            let flightStatus = "æº–å‚™å‡ºç™¼";
            let targetDate = outboundDate;
            let flightCode = "IT 720 (å»ç¨‹)";

            if (now > outboundDate && now < inboundDate) {
                flightStatus = "å›ç¨‹å€’æ•¸";
                targetDate = inboundDate;
                flightCode = "IT 721 (å›ç¨‹)";
            } else if (now > inboundDate) {
                flightStatus = "æ—…ç¨‹çµæŸ";
                targetDate = null;
            }

            const diff = targetDate ? targetDate - now : 0;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            const saveTitle = () => { localStorage.setItem('fukuoka_app_title', appTitle); setIsEditingTitle(false); };
            const saveLeader = () => {
                setLeaderInfo(tempLeader);
                setApiKey(tempKey);
                setIsEditingLeader(false);
            };

            const fetchWeather = () => {
                setLoadingWeather(true);
                setWeatherError(null);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`);
                            const data = await res.json();
                            setWeather(data.current_weather);
                        } catch (e) { setWeatherError("å¤©æ°£ç²å–å¤±æ•—"); }
                        setLoadingWeather(false);
                    }, (err) => { 
                        console.log("Weather GPS Error:", err);
                        setWeatherError("ç„¡æ³•å®šä½ (è«‹åœ¨æ‰‹æ©Ÿé–‹å•ŸGPS)");
                        setLoadingWeather(false); 
                    });
                } else {
                    setWeatherError("ç€è¦½å™¨ä¸æ”¯æ´");
                    setLoadingWeather(false);
                }
            };

            return (
                <div className="h-full overflow-y-auto pb-28 bg-[#FFF7ED]">
                    <div className="bg-gradient-to-br from-indigo-300 to-purple-300 text-white p-8 pb-12 rounded-b-[3rem] shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-[60px] -mr-16 -mt-16"></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start">
                                <div className="inline-block px-4 py-1.5 bg-white/20 backdrop-blur-md rounded-full text-white text-xs font-bold mb-4 border border-white/30 shadow-sm">2024.12.09 - 12.15</div>
                                <button onClick={() => setIsEditingTitle(!isEditingTitle)} className="text-white/70 hover:text-white bg-white/10 p-2 rounded-full"><Icon name="Edit" size={16}/></button>
                            </div>
                            {isEditingTitle ? (
                                <div className="flex gap-2">
                                    <input value={appTitle} onChange={(e) => setAppTitle(e.target.value)} className="text-slate-800 text-lg p-3 rounded-xl flex-1 shadow-lg outline-none"/>
                                    <button onClick={saveTitle} className="bg-white text-indigo-600 px-4 rounded-xl text-sm font-bold shadow-lg">å„²å­˜</button>
                                </div>
                            ) : (
                                <h1 className="text-3xl font-black mb-2 tracking-tight leading-tight drop-shadow-sm">{appTitle}</h1>
                            )}
                            <p className="text-white/80 text-sm font-medium">Fukuoka Tactical Field Manual</p>
                        </div>
                    </div>

                    <div className="p-5 space-y-5 -mt-10 relative z-20">
                        <div className="bg-white p-5 rounded-3xl shadow-lg shadow-indigo-100/50 border border-white">
                            <div className="flex justify-between items-start mb-4">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="User" size={18} className="text-indigo-400"/> é ˜éšŠè³‡è¨Š & API</h3>
                                <button onClick={() => isEditingLeader ? saveLeader() : setIsEditingLeader(true)} className="text-xs font-bold text-indigo-500 bg-indigo-50 px-3 py-1.5 rounded-full hover:bg-indigo-100 transition">{isEditingLeader ? 'å„²å­˜' : 'ç·¨è¼¯'}</button>
                            </div>
                            {isEditingLeader ? (
                                <div className="space-y-3">
                                    <input placeholder="é ˜éšŠå§“å" value={tempLeader.name} onChange={(e) => setTempLeader({...tempLeader, name: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100"/>
                                    <input placeholder="æ‰‹æ©Ÿ" value={tempLeader.phone} onChange={(e) => setTempLeader({...tempLeader, phone: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100"/>
                                    <input placeholder="Line ID" value={tempLeader.line} onChange={(e) => setTempLeader({...tempLeader, line: e.target.value})} className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100"/>
                                    <div className="pt-3 border-t border-slate-50 mt-2">
                                        <label className="text-xs text-slate-400 block mb-2 font-bold">Google Gemini API Key (é¸å¡«):</label>
                                        <input 
                                            type="password" 
                                            placeholder="è²¼ä¸Š API Key ä»¥å•Ÿç”¨ AI è¨˜å¸³" 
                                            value={tempKey} 
                                            onChange={(e) => setTempKey(e.target.value)}
                                            className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm font-mono focus:ring-2 focus:ring-indigo-100"
                                        />
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    <div className="flex items-center gap-4">
                                        <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center text-indigo-400 shadow-sm">
                                            {leaderInfo.name ? <span className="text-xl font-black">{leaderInfo.name[0]}</span> : <Icon name="User" size={28}/>}
                                        </div>
                                        <div>
                                            <div className="font-bold text-slate-800 text-lg">{leaderInfo.name || "æœªè¨­å®šé ˜éšŠ"}</div>
                                            <div className="text-sm text-slate-400 flex gap-3 mt-1">
                                                <span className="flex items-center gap-1"><Icon name="Phone" size={12}/> {leaderInfo.phone || "--"}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {apiKey && (
                                        <div className="flex items-center gap-2 bg-green-50 p-3 rounded-xl text-xs font-bold text-green-600 border border-green-100">
                                            <Icon name="CheckSquare" size={14}/> AI åŠŸèƒ½å·²å•Ÿç”¨ (Gemini)
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {targetDate && (
                            <div className="bg-white p-5 rounded-3xl shadow-lg shadow-blue-100/50 border border-white relative overflow-hidden group hover:shadow-xl transition">
                                <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-[3rem] -mr-6 -mt-6 z-0 group-hover:bg-blue-100 transition"></div>
                                <div className="relative z-10">
                                    <div className="flex items-center gap-3 mb-4">
                                        <div className="p-2.5 bg-blue-100 text-blue-600 rounded-xl shadow-sm"><Icon name="Train" size={20}/></div> 
                                        <div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider">{flightStatus}</div><div className="font-black text-slate-800 text-lg">{flightCode}</div></div>
                                    </div>
                                    <div className="flex justify-between items-end">
                                        <div className="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-indigo-500 font-mono tracking-tighter">{days}<span className="text-sm text-slate-400 font-sans font-bold ml-1 mr-3">å¤©</span>{hours}<span className="text-sm text-slate-400 font-sans font-bold ml-1">æ™‚</span></div>
                                        <div className="text-xs text-slate-400 font-mono bg-slate-50 px-2 py-1 rounded-lg">{targetDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} èµ·é£›</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-5 rounded-3xl shadow-lg shadow-orange-100/50 border border-white flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-2"><Icon name="Sun" size={18} className="text-orange-400"/> ç¾åœ°æ°£å€™</h3>
                                {weather ? <div className="text-3xl font-black text-slate-800">{weather.temperature}Â°C</div> : <button onClick={fetchWeather} className="text-xs bg-orange-50 text-orange-600 px-4 py-2 rounded-xl font-bold mt-1 hover:bg-orange-100 transition">{loadingWeather ? "é€£ç·šä¸­..." : (weatherError || "é»æ­¤æŠ“å–ä½ç½®å¤©æ°£")}</button>}
                            </div>
                            {weather && <div className="text-right"><div className="text-xs text-slate-400 font-medium mb-1">é¢¨é€Ÿ: {weather.windspeed} km/h</div><button onClick={fetchWeather} className="text-xs text-blue-500 font-bold bg-blue-50 px-3 py-1 rounded-lg">é‡æ–°æ•´ç†</button></div>}
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => setActiveTab('itinerary')} className="bg-white p-5 rounded-3xl shadow-lg shadow-indigo-100/50 border border-white flex flex-col items-center gap-3 hover:scale-[1.02] transition active:scale-95">
                                <div className="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-500 flex items-center justify-center shadow-sm"><Icon name="Calendar" size={24} /></div>
                                <span className="font-bold text-slate-700 text-sm">è¡Œç¨‹è¡¨</span>
                            </button>
                            <button onClick={() => setActiveTab('map')} className="bg-white p-5 rounded-3xl shadow-lg shadow-green-100/50 border border-white flex flex-col items-center gap-3 hover:scale-[1.02] transition active:scale-95">
                                <div className="w-12 h-12 rounded-2xl bg-green-50 text-green-500 flex items-center justify-center shadow-sm"><Icon name="Map" size={24} /></div>
                                <span className="font-bold text-slate-700 text-sm">å®šä½åœ°åœ–</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ToolboxTab = () => {
            const [jpy, setJpy] = useState('');
            const [rate, setRate] = useState(0.22);
            const [isAddressBig, setIsAddressBig] = useState(false);
            const [price, setPrice] = useState('');
            const [discount, setDiscount] = useState(10);
            const [coupon, setCoupon] = useState(5);

            const phrases = [
                { jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Sumimasen", zh: "ä¸å¥½æ„æ€" },
                { jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Kore o onegaishimasu", zh: "æˆ‘è¦é€™å€‹" },
                { jp: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Okaikei o onegaishimasu", zh: "éº»ç…©çµå¸³" },
                { jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹", romaji: "Toire wa doko desu ka", zh: "å»æ‰€åœ¨å“ªè£¡" },
                { jp: "è¢‹ã¯ã„ã‚Šã¾ã›ã‚“", romaji: "Fukuro wa irimasen", zh: "ä¸ç”¨è¢‹å­" }
            ];

            const links = [
                { name: "Google Maps", url: "https://www.google.com/maps", icon: "MapPin", color: "text-red-500", bg: "bg-red-50" },
                { name: "Tabelog (ç¾é£Ÿ)", url: "https://tabelog.com/", icon: "Utensils", color: "text-orange-500", bg: "bg-orange-50" },
                { name: "ãƒ­ã‚±ã‚¹ãƒ (æ‰¾åº—)", url: "https://www.locationsmart.org/", icon: "MapPin", color: "text-purple-500", bg: "bg-purple-50" },
                { name: "Yahoo! ä¹˜æ›", url: "https://transit.yahoo.co.jp/", icon: "Train", color: "text-green-600", bg: "bg-green-50" }
            ];

            const finalPrice = price ? Math.round(price * (1 - (discount/100)) * (1 - (coupon/100))) : 0;
            const finalTwd = Math.round(finalPrice * rate);

            return (
                <div className="h-full overflow-y-auto p-5 space-y-5 pb-32 bg-[#FFF7ED]">
                    <div className="grid grid-cols-2 gap-3">
                        {links.map((link, i) => (
                            <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="bg-white p-4 rounded-2xl shadow-sm border border-white flex items-center gap-3 hover:bg-white/80 transition no-underline">
                                <div className={`p-2.5 rounded-xl ${link.bg} ${link.color}`}><Icon name={link.icon} size={18}/></div>
                                <span className="font-bold text-slate-700 text-sm">{link.name}</span>
                            </a>
                        ))}
                    </div>

                    <div className="bg-white rounded-3xl shadow-lg shadow-indigo-100/50 border border-white overflow-hidden">
                        <div className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-4 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Car" size={18}/> é‹å°‡å¡</h3>
                            <button onClick={() => setIsAddressBig(!isAddressBig)} className="text-xs bg-white/20 px-3 py-1.5 rounded-lg backdrop-blur-sm hover:bg-white/30 transition font-bold">{isAddressBig ? "ç¸®å°" : "æ”¾å¤§"}</button>
                        </div>
                        <div className={`p-6 flex flex-col justify-center items-center text-center transition-all duration-300 ${isAddressBig ? "fixed inset-0 z-[999] bg-white justify-center h-screen p-10" : ""}`}>
                            {isAddressBig && <button onClick={() => setIsAddressBig(false)} className="absolute top-6 right-6 bg-slate-100 p-3 rounded-full shadow-lg"><Icon name="ChevronDown" size={28}/></button>}
                            <p className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-3">DESTINATION</p>
                            <h2 className={`font-black text-slate-800 leading-tight mb-4 ${isAddressBig ? "text-5xl" : "text-2xl"}`}>LIVEIL<br/>HAKATAEKIMAE</h2>
                            <p className={`font-bold text-slate-600 bg-slate-50 p-5 rounded-2xl w-full ${isAddressBig ? "text-2xl" : "text-sm"}`}>ã€’812-0011<br/>ç¦å²¡å¸‚åšå¤šåŒº<br/>åšå¤šé§…å‰4ä¸ç›®31-11</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-lg shadow-pink-100/50 border border-white p-5">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-5"><Icon name="Percent" size={18} className="text-pink-500"/> æŠ˜æ‰£è¨ˆç®—æ©Ÿ</h3>
                        <div className="grid grid-cols-3 gap-3 mb-5">
                            <div className="col-span-3"><label className="text-[10px] font-bold text-slate-400 mb-1 block ml-1">åŸåƒ¹ (JPY)</label><input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="0" className="w-full text-2xl font-black p-3 bg-slate-50 rounded-xl border-none focus:ring-2 focus:ring-pink-100 outline-none text-slate-800"/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 mb-1 block ml-1">å…ç¨… %</label><input type="number" value={discount} onChange={e => setDiscount(e.target.value)} className="w-full p-3 bg-slate-50 border-none rounded-xl text-center font-bold text-slate-700"/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 mb-1 block ml-1">å„ªæƒ  %</label><input type="number" value={coupon} onChange={e => setCoupon(e.target.value)} className="w-full p-3 bg-slate-50 border-none rounded-xl text-center font-bold text-slate-700"/></div>
                            <div><label className="text-[10px] font-bold text-slate-400 mb-1 block ml-1">åŒ¯ç‡</label><input type="number" value={rate} step="0.001" onChange={e => setRate(e.target.value)} className="w-full p-3 bg-slate-50 border-none rounded-xl text-center font-bold text-slate-700"/></div>
                        </div>
                        <div className="bg-slate-800 text-white p-4 rounded-2xl flex justify-between items-center shadow-lg">
                            <span className="text-xs opacity-60 font-bold">æŠ˜å¾Œå°å¹£ç´„</span><span className="text-3xl font-black">NT$ {finalTwd.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-lg shadow-green-100/50 border border-white p-5">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-4"><Icon name="DollarSign" size={18} className="text-green-500"/> ç°¡æ˜“åŒ¯ç‡</h3>
                        <div className="flex gap-3 items-center">
                            <div className="flex-1">
                                <input 
                                    type="number" 
                                    value={jpy}
                                    onChange={(e) => setJpy(e.target.value)}
                                    placeholder="æ—¥å¹£"
                                    className="w-full text-xl font-bold p-3 bg-slate-50 rounded-xl border-none outline-none text-slate-800"
                                />
                            </div>
                            <Icon name="Refresh" size={20} className="text-slate-300"/>
                            <div className="flex-1">
                                <div className="w-full text-xl font-bold p-3 text-slate-800 bg-slate-50 rounded-xl border-none">
                                    NT$ {jpy ? Math.round(jpy * rate).toLocaleString() : "0"}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-3xl shadow-lg shadow-orange-100/50 border border-white overflow-hidden">
                        <div className="bg-orange-50 p-4 border-b border-orange-100">
                            <h3 className="font-bold text-orange-600 flex items-center gap-2"><Icon name="Type" size={18}/> ç”Ÿå­˜æ—¥èª</h3>
                        </div>
                        <div className="divide-y divide-slate-50">
                            {phrases.map((p, i) => (
                                <div key={i} className="p-4 hover:bg-slate-50 transition">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-slate-700">{p.zh}</span>
                                        <span className="text-xs text-slate-400 font-mono bg-slate-100 px-2 py-0.5 rounded">{p.romaji}</span>
                                    </div>
                                    <div className="text-lg text-blue-500 font-bold tracking-wide">{p.jp}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseTracker = ({ apiKey }) => {
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('fukuoka_expenses');
                return saved ? JSON.parse(saved) : [{ id: 1, item: 'è¨ˆç¨‹è»Š', amount: 2500, cat: 'transport' }];
            });
            const [newItem, setNewItem] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newCat, setNewCat] = useState('food');
            const [isScanning, setIsScanning] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => { localStorage.setItem('fukuoka_expenses', JSON.stringify(expenses)); }, [expenses]);

            const addExpense = () => {
                if (!newItem || !newAmount) return;
                setExpenses([...expenses, { id: Date.now(), item: newItem, amount: parseInt(newAmount), cat: newCat }]);
                setNewItem('');
                setNewAmount('');
            };

            const deleteExpense = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setExpenses(prev => prev.filter(item => item.id !== id));
            };

            const triggerCamera = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!apiKey) {
                    alert("è«‹å…ˆè‡³é¦–é (ç·¨è¼¯é ˜éšŠè³‡è¨Š)è¨­å®š Gemini API Key æ‰èƒ½ä½¿ç”¨ AI æƒæåŠŸèƒ½ï¼");
                    return;
                }

                setIsScanning(true);

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onloadend = async () => {
                    const base64Data = reader.result.split(',')[1];
                    
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: "Analyze this receipt. Return ONLY a JSON object with keys: 'item' (merchant name or main item), 'amount' (total number only, no currency symbol), and 'cat' (one of: 'food', 'shopping', 'transport', 'other'). Do not include markdown formatting." },
                                        { inline_data: { mime_type: file.type, data: base64Data } }
                                    ]
                                }]
                            })
                        });

                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);

                        const text = data.candidates[0].content.parts[0].text;
                        const jsonText = text.replace(/```json|```/g, '').trim();
                        const result = JSON.parse(jsonText);

                        setNewItem(result.item);
                        setNewAmount(result.amount);
                        setNewCat(result.cat);
                        alert(`æƒææˆåŠŸï¼\nåº—å®¶ï¼š${result.item}\né‡‘é¡ï¼š${result.amount}`);

                    } catch (error) {
                        console.error(error);
                        alert("æƒæå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚\n" + error.message);
                    } finally {
                        setIsScanning(false);
                        if (fileInputRef.current) fileInputRef.current.value = '';
                    }
                };
            };

            const total = expenses.reduce((sum, ex) => sum + ex.amount, 0);

            return (
                <div className="p-5 space-y-5 bg-[#FFF7ED] h-full overflow-y-auto pb-32">
                    <div className="bg-slate-900 p-6 rounded-3xl shadow-xl shadow-slate-300 relative overflow-hidden text-white">
                        <div className="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div className="relative z-10">
                            <div className="text-white/60 text-sm font-bold tracking-widest mb-1 uppercase">Total Expenses</div>
                            <div className="text-5xl font-black tracking-tighter">Â¥ {total.toLocaleString()}</div>
                        </div>
                        
                        <button 
                            className="absolute right-5 top-5 p-3 bg-white/20 backdrop-blur-md rounded-2xl text-white active:scale-95 transition z-20 hover:bg-white/30"
                            onClick={triggerCamera}
                            disabled={isScanning}
                        >
                             {isScanning ? (
                                 <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                             ) : (
                                 <Icon name="Camera" size={24} />
                             )}
                        </button>
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            className="hidden" 
                            accept="image/*" 
                            capture="environment"
                            onChange={handleImageUpload}
                        />
                    </div>

                    <div className="bg-white p-5 rounded-3xl shadow-lg shadow-indigo-100/50 border border-white space-y-3">
                        <div className="flex justify-between items-center mb-1">
                            <h3 className="font-bold text-slate-700">æ–°å¢æ¶ˆè²»</h3>
                        </div>
                        <div className="space-y-3">
                            <input placeholder="é …ç›®åç¨±" className="w-full p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 transition" value={newItem} onChange={e => setNewItem(e.target.value)} />
                            <div className="flex gap-3">
                                <input type="number" placeholder="é‡‘é¡" className="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 transition" value={newAmount} onChange={e => setNewAmount(e.target.value)} />
                                <select className="flex-1 p-3 bg-slate-50 border-none rounded-xl text-sm focus:ring-2 focus:ring-indigo-100 transition text-slate-600" value={newCat} onChange={e => setNewCat(e.target.value)}>
                                    <option value="food">é¤é£²</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="other">å…¶ä»–</option>
                                </select>
                            </div>
                        </div>
                        <button onClick={addExpense} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm active:scale-95 transition shadow-lg shadow-slate-200 mt-2">ç´€éŒ„ä¸€ç­†</button>
                    </div>
                    
                    <div className="space-y-3">
                         <h3 className="font-bold text-slate-400 text-xs uppercase tracking-widest ml-2">History</h3>
                        {expenses.slice().reverse().map(ex => (
                            <div key={ex.id} className="flex justify-between items-center bg-white p-4 rounded-2xl border border-white shadow-sm hover:shadow-md transition">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-xl ${
                                        ex.cat === 'food' ? 'bg-orange-50 text-orange-500' : 
                                        ex.cat === 'transport' ? 'bg-blue-50 text-blue-500' : 
                                        ex.cat === 'shopping' ? 'bg-pink-50 text-pink-500' : 'bg-slate-50 text-slate-500'
                                    }`}>
                                        <Icon name={ex.cat === 'food' ? 'Utensils' : ex.cat === 'shopping' ? 'ShoppingBag' : ex.cat === 'transport' ? 'Train' : 'CreditCard'} size={20}/>
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-700">{ex.item}</div>
                                        <div className="text-xs text-slate-400 capitalize">{ex.cat === 'food' ? 'é¤é£²' : ex.cat === 'transport' ? 'äº¤é€š' : ex.cat === 'shopping' ? 'è³¼ç‰©' : 'å…¶ä»–'}</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-black text-slate-800">Â¥{ex.amount.toLocaleString()}</span>
                                    <button onClick={() => deleteExpense(ex.id)} className="text-slate-300 hover:text-red-400 transition p-2"><Icon name="Trash2" size={18}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ItineraryDay = ({ dayData, onDeleteTask, onAddTask }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [isAdding, setIsAdding] = useState(false);
            const [newTask, setNewTask] = useState({ time: '', title: '', type: 'sightseeing' });

            useEffect(() => { if (dayData.day === 1) setIsOpen(true); }, [dayData.day]);

            const handleSave = () => {
                if (!newTask.title) return;
                onAddTask(dayData.day, { ...newTask, id: 't' + Date.now() });
                setIsAdding(false);
            };

            return (
                <div className="bg-white rounded-3xl shadow-lg shadow-indigo-50/50 border border-white overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <div onClick={() => setIsOpen(!isOpen)} className="p-5 flex items-center justify-between cursor-pointer bg-white hover:bg-slate-50 transition">
                        <div className="flex items-center gap-5">
                            <div className="bg-gradient-to-br from-indigo-500 to-purple-600 text-white w-12 h-12 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg shadow-indigo-200">{dayData.day}</div>
                            <div><div className="text-xs text-slate-400 font-bold uppercase tracking-wider mb-0.5">{dayData.date}</div><div className="text-slate-800 font-black text-lg">{dayData.theme}</div></div>
                        </div>
                        <div className={`transition-transform duration-300 ${isOpen ? 'rotate-180' : ''} text-slate-400`}>
                            <Icon name="ChevronDown" size={20} />
                        </div>
                    </div>
                    {isOpen && (
                        <div className="p-5 pt-0 space-y-6 border-t border-slate-50 mt-2">
                            <div className="relative pl-4 pt-4 space-y-6 border-l-2 border-slate-100 ml-2">
                                {dayData.tasks.map((task) => (
                                    <div key={task.id} className="relative pl-6">
                                        <div className={`absolute -left-[29px] top-0 w-3.5 h-3.5 rounded-full border-2 border-white shadow-sm z-10 ${
                                            task.type === 'food' ? 'bg-orange-400' : 
                                            task.type === 'shopping' ? 'bg-pink-400' : 
                                            task.type === 'transport' ? 'bg-green-400' : 'bg-blue-400'
                                        }`}></div>
                                        
                                        <div className="flex flex-col gap-1">
                                            <div className="flex justify-between items-start">
                                                <div>
                                                    <span className="inline-block text-[10px] font-black text-slate-400 bg-slate-100 px-2 py-0.5 rounded mb-1">{task.time}</span>
                                                    <div className="font-bold text-slate-800 text-base leading-tight">{task.title}</div>
                                                </div>
                                                <button onClick={() => onDeleteTask(dayData.day, task.id)} className="text-slate-200 hover:text-red-400 transition"><Icon name="Trash2" size={14}/></button>
                                            </div>
                                            
                                            {task.note && <div className="text-xs text-slate-500 bg-slate-50 p-2 rounded-lg border border-slate-100 mt-1">{task.note}</div>}
                                            
                                            {task.map && (
                                                <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(task.map)} Fukuoka`} target="_blank" className="inline-flex items-center gap-1 text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg self-start mt-1 hover:bg-blue-100 transition">
                                                    <Icon name="Navigation" size={10} /> å°èˆª
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {!isAdding ? (
                                <button onClick={() => setIsAdding(true)} className="w-full py-3 bg-slate-50 text-slate-400 rounded-xl text-sm font-bold hover:bg-slate-100 transition dashed border-2 border-slate-100">+ æ–°å¢è¡Œç¨‹</button>
                            ) : (
                                <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 space-y-3 animate-pulse-once">
                                    <div className="flex gap-2">
                                        <input placeholder="æ™‚é–“" className="w-1/3 p-2 text-sm border-none bg-white rounded-lg shadow-sm" value={newTask.time} onChange={e => setNewTask({...newTask, time: e.target.value})}/>
                                        <select className="w-1/3 p-2 text-sm border-none bg-white rounded-lg shadow-sm text-slate-600" value={newTask.type} onChange={e => setNewTask({...newTask, type: e.target.value})}>
                                            <option value="sightseeing">æ™¯é»</option><option value="food">ç¾é£Ÿ</option><option value="shopping">è³¼ç‰©</option><option value="transport">äº¤é€š</option>
                                        </select>
                                    </div>
                                    <input placeholder="è¡Œç¨‹æ¨™é¡Œ" className="w-full p-2 text-sm border-none bg-white rounded-lg shadow-sm" value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})}/>
                                    <input placeholder="å‚™è¨» (é¸å¡«)" className="w-full p-2 text-sm border-none bg-white rounded-lg shadow-sm" value={newTask.note} onChange={e => setNewTask({...newTask, note: e.target.value})}/>
                                    <div className="flex gap-2 mt-2">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-2 text-slate-500 text-sm font-bold bg-white rounded-lg">å–æ¶ˆ</button>
                                        <button onClick={handleSave} className="flex-1 py-2 text-white text-sm font-bold bg-slate-800 rounded-lg shadow-lg">ç¢ºèª</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const ChecklistTab = ({ items, toggleItem }) => {
            return (
                <div className="h-full overflow-y-auto p-5 space-y-5 pb-32 bg-[#FFF7ED]">
                    <div className="bg-gradient-to-r from-emerald-400 to-teal-500 text-white p-6 rounded-3xl shadow-lg shadow-emerald-200 relative overflow-hidden">
                         <div className="absolute right-0 bottom-0 w-32 h-32 bg-white/10 rounded-full blur-2xl -mr-10 -mb-10"></div>
                        <h2 className="text-xl font-black tracking-tight">æº–å‚™ç¢ºèªæ¸…å–®</h2>
                        <div className="mt-2 flex items-baseline gap-1">
                             <span className="text-4xl font-black">{items.filter(i => i.done).length}</span>
                             <span className="text-white/60 text-sm font-bold">/ {items.length} å®Œæˆ</span>
                        </div>
                        <div className="w-full bg-black/10 h-1.5 rounded-full mt-3 overflow-hidden">
                             <div className="bg-white h-full rounded-full transition-all duration-500" style={{width: `${(items.filter(i => i.done).length / items.length) * 100}%`}}></div>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl border border-white shadow-lg shadow-stone-100/50 overflow-hidden">
                        {items.map(item => (
                            <div key={item.id} onClick={() => toggleItem(item.id)} className="p-4 flex items-center gap-4 cursor-pointer hover:bg-stone-50 transition border-b border-stone-50 last:border-none group">
                                <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all duration-300 ${item.done ? 'bg-emerald-500 border-emerald-500 scale-110' : 'border-stone-200 bg-white group-hover:border-emerald-300'}`}>
                                    {item.done && <Icon name="Check" size={14} className="text-white"/>}
                                </div>
                                <span className={`font-bold transition-all ${item.done ? 'text-stone-300 line-through' : 'text-stone-700'}`}>{item.text}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [itinerary, setItinerary] = useState(() => JSON.parse(localStorage.getItem('fukuoka_itinerary')) || initialTripData.itinerary);
            const [checklist, setChecklist] = useState(() => JSON.parse(localStorage.getItem('fukuoka_checklist')) || initialChecklist);
            const [leaderInfo, setLeaderInfo] = useState(() => JSON.parse(localStorage.getItem('fukuoka_leader')) || { name: '', phone: '', line: '' });
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('fukuoka_api_key') || '');

            useEffect(() => { localStorage.setItem('fukuoka_itinerary', JSON.stringify(itinerary)); }, [itinerary]);
            useEffect(() => { localStorage.setItem('fukuoka_checklist', JSON.stringify(checklist)); }, [checklist]);
            useEffect(() => { localStorage.setItem('fukuoka_leader', JSON.stringify(leaderInfo)); }, [leaderInfo]);
            useEffect(() => { localStorage.setItem('fukuoka_api_key', apiKey); }, [apiKey]);

            const handleDeleteTask = (dayNum, taskId) => {
                if (window.confirm("åˆªé™¤ï¼Ÿ")) setItinerary(prev => prev.map(d => d.day === dayNum ? { ...d, tasks: d.tasks.filter(t => t.id !== taskId) } : d));
            };
            const handleAddTask = (dayNum, newTask) => {
                setItinerary(prev => prev.map(d => d.day === dayNum ? { ...d, tasks: [...d.tasks, newTask].sort((a,b)=>a.time.localeCompare(b.time)) } : d));
            };
            const toggleChecklist = (id) => setChecklist(prev => prev.map(i => i.id === id ? { ...i, done: !i.done } : i));

            return (
                <div className="flex flex-col h-full font-sans text-slate-800 bg-[#FFF7ED]">
                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'home' && <HomeTab leaderInfo={leaderInfo} setLeaderInfo={setLeaderInfo} setActiveTab={setActiveTab} apiKey={apiKey} setApiKey={setApiKey} />}
                        {activeTab === 'itinerary' && <div className="h-full overflow-y-auto p-5 pb-32 space-y-5">{itinerary.map(day => <ItineraryDay key={day.day} dayData={day} onDeleteTask={handleDeleteTask} onAddTask={handleAddTask} />)}</div>}
                        {activeTab === 'map' && <MapTab itinerary={itinerary} />}
                        {activeTab === 'wallet' && <ExpenseTracker apiKey={apiKey} />}
                        {activeTab === 'tools' && <ToolboxTab />}
                        {activeTab === 'checklist' && <ChecklistTab items={checklist} toggleItem={toggleChecklist} />}
                    </div>
                    
                    {/* Floating Navigation Island */}
                    <div className="fixed bottom-8 left-6 right-6 bg-white/90 backdrop-blur-xl border border-white/50 rounded-[2rem] shadow-2xl shadow-indigo-900/10 px-2 py-2 flex justify-between items-center z-50">
                        {[
                            { id: 'home', icon: 'Home', label: 'é¦–é ' },
                            { id: 'itinerary', icon: 'Calendar', label: 'è¡Œç¨‹' },
                            { id: 'map', icon: 'Map', label: 'åœ°åœ–' },
                            { id: 'wallet', icon: 'CreditCard', label: 'éŒ¢åŒ…' },
                            { id: 'tools', icon: 'Briefcase', label: 'å·¥å…·' }
                        ].map(tab => (
                            <button 
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)} 
                                className={`flex flex-col items-center gap-1 p-2 px-3 rounded-[1.5rem] transition-all duration-300 ${
                                    activeTab === tab.id 
                                        ? 'bg-slate-800 text-white scale-105 shadow-lg' 
                                        : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                <Icon name={tab.icon} size={20} className={activeTab === tab.id ? "stroke-[2.5px]" : "stroke-[2px]"}/>
                                {activeTab === tab.id && <span className="text-[10px] font-bold">{tab.label}</span>}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>