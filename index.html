<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- æ¨™é¡Œè¨­å®š -->
    <title>æ—ç³–ç³–çš„å¥´éš¸åƒåƒå–å–ç¦å²¡è¡Œ</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563EB">

    <!-- Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' ry='100' fill='%232563EB'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' ry='100' fill='%232563EB'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' fill='white' font-size='300' font-family='sans-serif' font-weight='bold'%3Eç³–%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href='data:application/manifest+json,{"name":"ç¦å²¡æˆ°è¡“","short_name":"ç¦å²¡æˆ°è¡“","display":"standalone","start_url":".","background_color":"#ffffff","theme_color":"#2563EB","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 rx=%27100%27 ry=%27100%27 fill=%27%232563EB%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27central%27 text-anchor=%27middle%27 fill=%27white%27 font-size=%27300%27 font-family=%27sans-serif%27 font-weight=%27bold%27%3Eç³–%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}'>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet Map CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        /* Map Container Height */
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        /* Leaflet Popups & Tooltips */
        .leaflet-popup-content-wrapper { border-radius: 12px; font-family: system-ui; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 12px; }
        .leaflet-tooltip { font-weight: bold; border-radius: 4px; border: 1px solid #cbd5e1; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 12px; padding: 4px 8px; color: #1e293b; background: rgba(255, 255, 255, 0.95); }
        
        /* Animations */
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    </style>
</head>
<body class="bg-gray-100 flex justify-center h-[100dvh] overflow-hidden">

    <div id="root" class="w-full h-full max-w-md bg-white shadow-2xl overflow-hidden relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                MapPin: <><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></>,
                Calendar: <><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></>,
                CheckSquare: <><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></>,
                CreditCard: <><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></>,
                Briefcase: <><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>,
                ShieldAlert: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
                ChevronDown: <polyline points="6 9 12 15 18 9"/>,
                ChevronUp: <polyline points="18 15 12 9 6 15"/>,
                Navigation: <polygon points="3 11 22 2 13 21 11 13 3 11"/>,
                Utensils: <><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></>,
                ShoppingBag: <><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></>,
                Train: <><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/><line x1="2" y1="17" x2="22" y2="17"/></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></>,
                Plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
                Trash2: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>,
                Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
                Phone: <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>,
                Car: <path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a1 1 0 0 0-.8.4L1.74 11l-5.16.85a1 1 0 0 0-.84.99V16h3m14 0v2a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2v-2m-8 0v2a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-2"/>,
                Refresh: <><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></>,
                DollarSign: <><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></>,
                Type: <><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></>,
                ExternalLink: <><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></>,
                Percent: <><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></>,
                Plane: <path d="M2 12h5l8 5 9-9-9-9-8 5H2v8z"/>,
                Map: <><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></>,
                Sun: <><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>,
                Cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>,
                Edit: <><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></>,
                X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10"/>}</svg>;
        };

        // --- GLOBAL CONSTANTS (Full Detail) ---
        const initialTripData = {
          itinerary: [
            {
              day: 1,
              date: "12/09 (é€±äºŒ)",
              theme: "åˆæŠµç¦åœ°",
              tasks: [
                { id: 't1-1', time: "11:00-13:30", title: "æ¡ƒåœ’æ©Ÿå ´ -> ç¦å²¡æ©Ÿå ´ (IT720)", type: "transport", lat: 33.5859, lng: 130.4507, note: "APPè‡ªåŠ©å ±åˆ°èˆ‡è¨—é‹ï¼Œé¿é–‹äººæ½®ã€‚" },
                { id: 't1-2', time: "16:55-18:00", title: "å…¥å¢ƒå¯©æŸ¥ & é ˜è¡Œæ", type: "transport", note: "é—œéµï¼šç«‹å³é–‹å•Ÿ VJW æˆªåœ–ï¼Œä¿æŒéšŠå½¢ã€‚" },
                { id: 't1-3', time: "18:00-18:45", title: "æ©Ÿå ´ -> é£¯åº— (è¨ˆç¨‹è»Š)", type: "transport", lat: 33.5861, lng: 130.4190, note: "å¾ A3 å‡ºå£æ­ä¹˜ï¼Œè»Šè³‡ç´„ Â¥2,500ã€‚ä¿ç•™é«”åŠ›ã€‚" },
                { id: 't1-4', time: "19:00-20:00", title: "Check-in & ä¼‘æ¯", type: "transport", note: "é•·è¼©ä¼‘æ¯ï¼Œç†Ÿæ‚‰é£¯åº—è¨­å‚™ã€‚" },
                { id: 't1-5', time: "20:00-21:30", title: "æ™šé¤ï¼šåšå¤šç¥‡åœ’é‰„ãªã¹", type: "food", map: "åšå¤šç¥‡åœ’é‰„ãªã¹", lat: 33.5912, lng: 130.4162, note: "æ’éšŠååº—ã€‚å‚™æ¡ˆBï¼šãŸã‚“ã‚„HAKATA (ç‰›èˆŒå®šé£Ÿ)ã€‚" },
                { id: 't1-6', time: "21:30+", title: "å¤œé–“æ¡è²·ï¼šMaxValu", type: "shopping", map: "MaxValu Express Hakata Ekimae", lat: 33.5855, lng: 130.4178, note: "å»ºç«‹åˆå§‹åº«å­˜(æ°´ã€æ°´æœã€æ—©é¤)ã€‚" }
              ]
            },
            {
              day: 2,
              date: "12/10 (é€±ä¸‰)",
              theme: "æ–°èˆŠäº¤è",
              tasks: [
                { id: 't2-1', time: "08:00-09:30", title: "æ—©é¤ï¼šDacomecca", type: "food", map: "Dacomecca", lat: 33.5895, lng: 130.4222, note: "æ’éšŠç‹è€…ï¼Œå»ºè­°å¹´è¼•æˆå“¡å…ˆå»æ’éšŠã€‚" },
                { id: 't2-2', time: "09:30-12:00", title: "æ«›ç”°ç¥ç¤¾ & å·ç«¯é€šå•†åº—è¡—", type: "sightseeing", map: "Kushida Shrine", lat: 33.5930, lng: 130.4106, note: "æ„Ÿå—åšå¤šæ–‡åŒ–æºé ­ã€‚" },
                { id: 't2-3', time: "10:15", title: "Full Full Hakata", type: "food", map: "Full Full Hakata", lat: 33.5942, lng: 130.4140, note: "è³¼è²·æ‹›ç‰Œæ˜å¤ªå­æ³•åœ‹éºµåŒ…ã€‚" },
                { id: 't2-4', time: "12:00-13:30", title: "åˆé¤ï¼šé°»é­šå››ä»£ç›®èŠå·", type: "food", map: "é°»é­šå››ä»£ç›®èŠå· ä¸­æ´²æ˜¥å‰åº—", lat: 33.5905, lng: 130.4075, note: "å‰å¡šé°»é­šå±‹å…¬ä¼‘ï¼Œæ”¹åƒé€™å®¶ (ä¸­æ´²æ˜¥å‰åº—)ã€‚" },
                { id: 't2-5', time: "13:30-15:00", title: "(é¸æ“‡æ€§) COCO'S å¤§æ©‹åº—", type: "food", map: "COCO'S Ohashi", note: "è‹¥é«”åŠ›ä¸è¶³å»ºè­°å–æ¶ˆï¼Œç›´æ¥å‰å¾€ Lalaportã€‚" },
                { id: 't2-6', time: "15:00-17:30", title: "Lalaport ç¦å²¡", type: "sightseeing", map: "LaLaport Fukuoka", lat: 33.5504, lng: 130.4463, note: "æœè– 1:1 é‹¼å½ˆç«‹åƒ (æ•´é»æœ‰æ¼”å‡º)ã€‚" },
                { id: 't2-7', time: "17:30-19:30", title: "æ™šé¤ï¼šç‡’è‚‰ å¤§æ±åœ’ æœ¬åº—", type: "food", map: "Daitoen Honten", lat: 33.5935, lng: 130.4128, note: "å¿…é ˆé ç´„ã€‚å‚™æ¡ˆBï¼šåšå¤šè¯å‘³é³¥ã€‚" },
                { id: 't2-8', time: "20:30+", title: "åšå¤šé‹æ²³åŸ", type: "sightseeing", map: "Canal City Hakata", lat: 33.5898, lng: 130.4108, note: "å¤œé–“æ°´èˆç§€ã€‚" }
              ]
            },
            {
              day: 3,
              date: "12/11 (é€±å››)",
              theme: "å¤ªå®°åºœç¦ªæ„",
              tasks: [
                { id: 't3-1', time: "10:00-11:00", title: "ç§»å‹•ï¼šåšå¤š -> å¤ªå®°åºœ", type: "transport", map: "Hakata Bus Terminal", note: "åšå¤šå·´å£«ç¸½ç«™ 1F 11è™Ÿæœˆå°æ­ä¹˜ã€Œæ—…äººã€è™Ÿã€‚" },
                { id: 't3-2', time: "11:00-14:30", title: "å¤ªå®°åºœç²¾è¯éŠ", type: "sightseeing", map: "Dazaifu Tenmangu", lat: 33.5215, lng: 130.5349, note: "è¡¨åƒé“æ¢…æé¤…ã€æ˜Ÿå·´å…‹ã€å¤©æ»¿å®®é£›æ¢…é¤¨ã€‚" },
                { id: 't3-3', time: "12:30", title: "åˆé¤ï¼šä¸€è˜­æ‹‰éºµ å¤ªå®°åºœåº—", type: "food", map: "Ichiran Dazaifu", lat: 33.5192, lng: 130.5317, note: "ç‰¹è‰²ï¼šåˆæ ¼äº”è§’ç¢—ã€‚" },
                { id: 't3-4', time: "14:30-16:00", title: "å…‰æ˜ç¦ªå¯º", type: "sightseeing", map: "Komyozenji", lat: 33.5186, lng: 130.5344, note: "æ¯å±±æ°´åº­åœ’ã€‚æ‹œè§€æ–™Â¥300åƒ…æ”¶ç¾é‡‘ã€‚" },
                { id: 't3-5', time: "17:00-19:00", title: "è¿”å›å¤©ç¥ & Pain Stock", type: "shopping", map: "stock", lat: 33.5900, lng: 130.4035, note: "å¤©ç¥ä¸­å¤®å…¬åœ’åº—ï¼Œå“åšéºµåŒ…èˆ‡å’–å•¡ã€‚" },
                { id: 't3-6', time: "19:00-21:00", title: "æ™šé¤ï¼šéºµå±‹å…¼è™", type: "food", map: "Menya Kanetora Tenjin", lat: 33.5886, lng: 130.3995, note: "æ²¾éºµååº—ã€‚å‚™æ¡ˆBï¼šå¤§ç ²æ‹‰éºµã€‚" }
              ]
            },
            {
              day: 4,
              date: "12/12 (é€±äº”)",
              theme: "æ¸¯éƒ½æ‡·èˆŠ",
              tasks: [
                { id: 't4-1', time: "09:00-10:20", title: "ç§»å‹•ï¼šåšå¤š -> é–€å¸æ¸¯", type: "transport", map: "Hakata Station", note: "é€Ÿåº¦æˆ°è¡“ï¼šæ–°å¹¹ç·šè‡³å°å€‰ï¼Œå†è½‰ä¹˜ JR è‡³é–€å¸æ¸¯ã€‚" },
                { id: 't4-2', time: "10:30-12:30", title: "é–€å¸æ¸¯æ‡·èˆŠå€æ•£ç­–", type: "sightseeing", map: "Mojiko Retro", lat: 33.9446, lng: 130.9633, note: "èˆŠä¸‰äº•ä¿±æ¨‚éƒ¨ã€è—ç¿¼é–€å¸åŠæ©‹ã€‚" },
                { id: 't4-3', time: "12:30-13:30", title: "åˆé¤ï¼šä¼½å“©æœ¬èˆ–", type: "food", map: "Curry Honpo Mojiko", lat: 33.9458, lng: 130.9615, note: "ç‡’å’–å“©åç‰©ï¼Œæ¨è–¦çª—é‚Šåº§ä½ã€‚" },
                { id: 't4-4', time: "13:30-15:30", title: "ä¸‹åˆèŒ¶ & é«”é©—", type: "sightseeing", map: "Karato Market", note: "æ–¹æ¡ˆA: é–€å¸æ¸¯å¸ƒä¸ / æ–¹æ¡ˆB: è¯çµ¡èˆ¹è‡³å”æˆ¶å¸‚å ´+æµ·åº•éš§é“ã€‚" },
                { id: 't4-5', time: "17:00-19:00", title: "ç§»å‹•ï¼šå°å€‰ -> åšå¤š", type: "transport", note: "è¿”å›åšå¤šæ™šé¤ã€‚" },
                { id: 't4-6', time: "19:00+", title: "æ™šé¤ï¼šä½†é¦¬å±‹ / å°æ—é¤Šé›", type: "food", map: "Hakata Station", lat: 33.5902, lng: 130.4207, note: "å£½å–œç‡’åƒåˆ°é£½ æˆ– æ—¥å¼å±…é…’å±‹ã€‚" }
              ]
            },
            {
              day: 5,
              date: "12/13 (é€±å…­)",
              theme: "åšå¤šç¾é£Ÿç²¾é«“",
              tasks: [
                { id: 't5-1', time: "08:30-10:00", title: "æ—©é¤ï¼šé£Ÿå ‚ ãŠã‚ã‚“", type: "food", map: "Shokudo Owan", lat: 33.5925, lng: 130.4135, note: "ç²¾ç·»æ—¥å¼å‚³çµ±æœé£Ÿã€‚" },
                { id: 't5-2', time: "10:00-12:00", title: "å¤©ç¥åœ°ä¸‹è¡—", type: "shopping", map: "Tenjin Underground Shopping Center", note: "è³¼ç‰©èˆ‡ä¼´æ‰‹ç¦®æ¡è²·ã€‚" },
                { id: 't5-3', time: "12:00-13:30", title: "åˆé¤ï¼šã¨ã‚“ã‹ã¤ã‚ã‹è‘‰", type: "food", map: "Tonkatsu Wakaba", lat: 33.5938, lng: 130.4032, note: "ç‚¸è±¬æ’ã€‚æ’éšŠå…‡çŒ›ï¼Œå»ºè­° 11:15 å‰æŠµé”ã€‚" },
                { id: 't5-4', time: "15:00-17:00", title: "åšå¤šé‹æ²³åŸ", type: "sightseeing", map: "Canal City Hakata", lat: 33.5898, lng: 130.4108, note: "è£œå®Œè³¼ç‰©è¡Œç¨‹ï¼Œè§€è³å™´æ°´ç§€ã€‚" },
                { id: 't5-5', time: "17:30-19:00", title: "æ™šé¤ï¼šè¯å‘³é³¥ / å‰ç”°å±‹", type: "food", map: "Hakata Hanamidori", lat: 33.5935, lng: 130.4110, note: "åˆ†çµ„è¡Œå‹•ï¼šæ¸…æ·¡æ°´ç‚Šé›é‹ vs æ¿ƒéƒç‰›è…¸é‹ã€‚éœ€é ç´„ã€‚" }
              ]
            },
            {
              day: 6,
              date: "12/14 (é€±æ—¥)",
              theme: "ç¦å²¡ç”Ÿæ´»å…‰è­œ",
              tasks: [
                { id: 't6-1', time: "09:00-10:30", title: "å…­æœ¬æ¾éºµåŒ…ï¼šAmam Dacotan", type: "food", map: "Amam Dacotan", lat: 33.5755, lng: 130.3768, note: "å…¨æ—¥æœ¬è©±é¡Œåº¦æœ€é«˜ã€‚å‚™æ¡ˆï¼šMatsu Panã€‚" },
                { id: 't6-2', time: "10:30-13:00", title: "å¤§æ¿ å…¬åœ’ & ç¾è¡“é¤¨", type: "sightseeing", map: "Ohori Park", lat: 33.5865, lng: 130.3763, note: "æ¹–ç•”äº«ç”¨éºµåŒ…ï¼Œæ¬£è³è‰é–“å½Œç”Ÿå—ç“œã€‚" },
                { id: 't6-3', time: "14:00-15:00", title: "åˆé¤ï¼šé­šå¿ ", type: "food", map: "Uochu", lat: 33.5835, lng: 130.3955, note: "é«˜ç´šé®®é­šåº—ç›´ç‡Ÿï¼ŒCPå€¼æ¥µé«˜æµ·é®®å®šé£Ÿã€‚" },
                { id: 't6-4', time: "15:00-16:30", title: "è—¥é™¢é¸ç‰© & Coffee County", type: "shopping", map: "Bãƒ»Bãƒ»B POTTERS", note: "ç”Ÿæ´»é›œè²¨æ•£ç­–ã€‚" },
                { id: 't6-5', time: "17:00-18:30", title: "è¥¿æ–°æ•£ç­– & ç¦å²¡å¡”", type: "sightseeing", map: "Fukuoka Tower", lat: 33.5933, lng: 130.3515, note: "èœ‚æ¨‚é¥…é ­ï¼Œæ¬£è³ç™¾é“æµ·æ¿±å¤œæ™¯ã€‚" },
                { id: 't6-6', time: "19:00+", title: "æ™šé¤ï¼šå°æ—é¤Šé› (è¥¿æ–°åº—)", type: "food", map: "Kobayashi Youkei Nishijin", lat: 33.5828, lng: 130.3555, note: "åœ¨åœ°äººå–œæ„›çš„å±…é…’å±‹ã€‚" }
              ]
            },
            {
              day: 7,
              date: "12/15 (é€±ä¸€)",
              theme: "å®Œç¾æ­¸é€”",
              tasks: [
                { id: 't7-1', time: "09:00-11:00", title: "é€€æˆ¿ & è¡Œæå¯„æ”¾", type: "transport", note: "é£¯åº—æ«ƒå°å¯„æ”¾è¡Œæã€‚" },
                { id: 't7-2', time: "11:00-13:30", title: "åšå¤šç«™æœ€å¾Œè¡åˆº", type: "shopping", map: "Hakata Hankyu", lat: 33.5895, lng: 130.4205, note: "é˜ªæ€¥B1/AMUã€‚å¿…è²·ï¼šç¦ç ‚å±‹ã€åŠªåŠªé›ã€‚" },
                { id: 't7-3', time: "12:00-13:00", title: "åˆé¤ï¼šåšå¤šéºµè¡—é“", type: "food", map: "Hakata Noodle Street", note: "æœ€å¾Œä¸€ç¢—æ‹‰éºµ (Shin-Shin/æµ·é³´)ã€‚" },
                { id: 't7-4', time: "14:00-15:00", title: "å‰å¾€æ©Ÿå ´", type: "transport", note: "å›é£¯åº—å–è¡Œæï¼Œæ­è¨ˆç¨‹è»Šç›´é”åœ‹éš›ç·šèˆªå»ˆã€‚" },
                { id: 't7-5', time: "15:00-15:15", title: "æŠµé”ç¦å²¡æ©Ÿå ´", type: "transport", map: "Fukuoka Airport International Terminal", lat: 33.5859, lng: 130.4507, note: "å‹™å¿…ææ—©ï¼Œå®‰æª¢æ’éšŠé•·ã€‚" },
                { id: 't7-6', time: "15:15-17:55", title: "å‡ºå¢ƒç¨‹åº & ç™»æ©Ÿ (IT721)", type: "transport", note: "17:55 èµ·é£›ã€‚å¹³å®‰æ­¸è³¦ã€‚" }
              ]
            }
          ]
        };

        const initialChecklist = [
          { id: 'c1', text: 'Visit Japan Web QR Code', done: false, cat: 'document' },
          { id: 'c3', text: 'è­·ç…§ (æ•ˆæœŸç¢ºèª)', done: false, cat: 'document' },
          { id: 'c10', text: 'ç¾é‡‘ (æ¯äººç´„ Â¥50,000)', done: false, cat: 'money' },
          { id: 'c12', text: 'ICå¡ (Suica/ICOCA)', done: false, cat: 'money' },
          { id: 'c14', text: 'è¡Œå‹•é›»æº & å……é›»ç·š', done: false, cat: 'other' }
        ];

        // --- COMPONENTS ---

        const MapTab = ({ itinerary }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const userMarkerRef = useRef(null);
            const [status, setStatus] = useState("é»æ“Šåœ°åœ–å¯æ–°å¢æ¨™è¨˜");
            const [userMarkers, setUserMarkers] = useState(() => JSON.parse(localStorage.getItem('fukuoka_user_markers')) || []);
            const [isAdding, setIsAdding] = useState(false);
            const [newMarkerPos, setNewMarkerPos] = useState(null);
            const [newMarkerName, setNewMarkerName] = useState('');
            const [newMarkerType, setNewMarkerType] = useState('food');

            useEffect(() => { localStorage.setItem('fukuoka_user_markers', JSON.stringify(userMarkers)); }, [userMarkers]);

            // Attach delete function to window safely
            useEffect(() => {
                window.fukuokaDeleteMarker = (id) => {
                    if(window.confirm('ç¢ºå®šåˆªé™¤æ­¤æ¨™è¨˜ï¼Ÿ')) {
                        setUserMarkers(prev => prev.filter(m => m.id !== id));
                    }
                };
                return () => { delete window.fukuokaDeleteMarker; };
            }, []);

            useEffect(() => {
                if (!mapInstanceRef.current && mapContainerRef.current) {
                    mapInstanceRef.current = L.map(mapContainerRef.current).setView([33.5902, 130.4207], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(mapInstanceRef.current);

                    mapInstanceRef.current.on('click', (e) => {
                        setNewMarkerPos(e.latlng);
                        setIsAdding(true);
                    });
                }

                const map = mapInstanceRef.current;

                // Clear existing markers
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker && layer !== userMarkerRef.current) {
                        map.removeLayer(layer);
                    }
                });

                const addMarkerToMap = (lat, lng, title, type, isUser = false, id = null) => {
                    let color = '#22C55E';
                    if (type === 'food') color = '#F97316';
                    if (type === 'sightseeing') color = '#3B82F6';
                    if (type === 'shopping') color = '#EC4899';
                    
                    const borderStyle = isUser ? 'border: 2px dashed white;' : 'border: 2px solid white;';
                    const markerHtml = `<div style="background-color:${color}; width:16px; height:16px; border-radius:50%; ${borderStyle} box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                    
                    const icon = L.divIcon({
                        className: 'custom-pin',
                        html: markerHtml,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8],
                        popupAnchor: [0, -10],
                        tooltipAnchor: [8, -4] 
                    });
                    
                    const marker = L.marker([lat, lng], { icon }).addTo(map);
                    
                    // Add Tooltip (Name label) for Hover/Tap
                    marker.bindTooltip(title, { 
                        permanent: false, 
                        direction: 'top',
                        offset: [0, -12],
                        opacity: 0.9
                    });

                    const googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(title)}`;
                    
                    let popupContent = `
                        <div style="text-align:center; min-width: 120px;">
                            <div style="font-weight:bold; color:#1e293b; margin-bottom:8px; font-size:14px;">${title}</div>
                            <a href="${googleMapLink}" target="_blank" style="background-color:#3B82F6; color:white; padding:6px 16px; border-radius:99px; text-decoration:none; font-size:12px; font-weight:bold; display:inline-block; box-shadow: 0 2px 4px rgba(59,130,246,0.3);">å°èˆª GO ></a>
                    `;

                    if (isUser) {
                        popupContent += `<div style="margin-top:12px; border-top:1px solid #eee; padding-top:8px;"><button onclick="window.fukuokaDeleteMarker(${id})" style="color:#ef4444; font-size:12px; border:none; background:none; text-decoration:underline; cursor:pointer; font-weight:bold;">åˆªé™¤æ­¤æ¨™è¨˜</button></div>`;
                    }
                    
                    popupContent += `</div>`;
                    marker.bindPopup(popupContent);
                };

                // Add Markers
                itinerary.forEach(day => {
                    day.tasks.forEach(task => {
                        if (task.lat && task.lng) {
                            addMarkerToMap(task.lat, task.lng, task.title, task.type);
                        }
                    });
                });

                userMarkers.forEach(m => {
                    addMarkerToMap(m.lat, m.lng, m.title, m.type, true, m.id);
                });

                // User Location
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            if (map) {
                                if (!userMarkerRef.current) {
                                    const userIcon = L.divIcon({
                                        className: 'user-pin',
                                        html: "<div style='background-color:#2563EB; width:16px; height:16px; border-radius:50%; border:3px solid white; box-shadow: 0 0 0 4px rgba(37,99,235,0.4);'></div>",
                                        iconSize: [24, 24],
                                        iconAnchor: [12, 12]
                                    });
                                    userMarkerRef.current = L.marker([latitude, longitude], {icon: userIcon, zIndexOffset: 1000}).addTo(map);
                                } else {
                                    userMarkerRef.current.setLatLng([latitude, longitude]);
                                }
                            }
                        },
                        (error) => { console.log("GPS Error", error); },
                        { enableHighAccuracy: true }
                    );
                }
            }, [itinerary, userMarkers]); 

            const confirmAddMarker = () => {
                if (!newMarkerName || !newMarkerPos) return;
                const newMarker = {
                    id: Date.now(),
                    lat: newMarkerPos.lat,
                    lng: newMarkerPos.lng,
                    title: newMarkerName,
                    type: newMarkerType
                };
                setUserMarkers([...userMarkers, newMarker]);
                setIsAdding(false);
                setNewMarkerName('');
            };

            return (
                <div className="h-full flex flex-col bg-slate-50 relative">
                    {/* Instructions Overlay */}
                    <div className="absolute top-4 left-4 right-4 z-[400] bg-white/90 backdrop-blur px-4 py-2 rounded-xl shadow-lg border border-slate-200 flex justify-between items-center">
                        <span className="text-xs font-bold text-slate-600">ğŸ‘† é»æ“Šåœ°åœ–ï¼šå…ˆåµå¯Ÿ</span>
                        <div className="flex gap-2 text-[10px] font-bold text-slate-500">
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-orange-500"></span>é£Ÿ</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span>ç©</span>
                            <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-500"></span>è³¼</span>
                        </div>
                    </div>
                    
                    {/* Add Marker Modal (Recon Mode) */}
                    {isAdding && (
                        <div className="absolute inset-0 z-[500] bg-black/20 flex items-center justify-center p-4">
                            <div className="bg-white p-4 rounded-2xl shadow-2xl w-full max-w-xs animate-bounce-in">
                                <h3 className="font-bold text-slate-800 mb-1">ğŸ“ åµå¯Ÿæ–°åœ°é»</h3>
                                <p className="text-xs text-slate-500 mb-3">åº§æ¨™: {newMarkerPos.lat.toFixed(4)}, {newMarkerPos.lng.toFixed(4)}</p>
                                
                                <a 
                                    href={`https://www.google.com/maps/search/?api=1&query=${newMarkerPos.lat},${newMarkerPos.lng}`}
                                    target="_blank"
                                    className="block w-full text-center py-2 mb-4 bg-blue-50 text-blue-600 rounded-lg text-sm font-bold border border-blue-100 hover:bg-blue-100"
                                >
                                    ğŸ” åœ¨ Google Maps ç¢ºèªæ­¤è™•
                                </a>

                                <div className="border-t border-slate-100 pt-3">
                                    <label className="text-xs font-bold text-slate-400 block mb-1">ç¢ºèªè¦æ–°å¢å—ï¼Ÿè«‹è¼¸å…¥åç¨±ï¼š</label>
                                    <input 
                                        placeholder="ä¾‹å¦‚ï¼šå¥½åƒçš„æ‹‰éºµ" 
                                        className="w-full p-2 mb-3 border rounded-lg text-sm"
                                        value={newMarkerName}
                                        onChange={e => setNewMarkerName(e.target.value)}
                                        autoFocus
                                    />
                                    <div className="flex gap-2 mb-3">
                                        {['food', 'sightseeing', 'shopping'].map(t => (
                                            <button 
                                                key={t}
                                                onClick={() => setNewMarkerType(t)}
                                                className={`flex-1 py-1 rounded text-xs font-bold capitalize border ${newMarkerType === t ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-500 border-slate-200'}`}
                                            >
                                                {t === 'food' ? 'é£Ÿ' : t === 'sightseeing' ? 'ç©' : 'è³¼'}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setIsAdding(false)} className="flex-1 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                                        <button onClick={confirmAddMarker} className="flex-1 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">ç¢ºèªæ–°å¢</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div id="map" ref={mapContainerRef} className="flex-1 w-full h-full z-0"></div>
                </div>
            );
        };

        const HomeTab = ({ leaderInfo, setLeaderInfo, setActiveTab }) => {
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [appTitle, setAppTitle] = useState(() => localStorage.getItem('fukuoka_app_title') || "æ—ç³–ç³–çš„å¥´éš¸åƒåƒå–å–ç¦å²¡è¡Œ");
            const [isEditingLeader, setIsEditingLeader] = useState(false);
            const [tempLeader, setTempLeader] = useState(leaderInfo);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(false);
            const [weatherError, setWeatherError] = useState(null);

            useEffect(() => { setTempLeader(leaderInfo); }, [leaderInfo]);

            const now = new Date();
            const outboundDate = new Date("2024-12-09T13:30:00+09:00");
            const inboundDate = new Date("2024-12-15T17:55:00+09:00");
            let flightStatus = "æº–å‚™å‡ºç™¼";
            let targetDate = outboundDate;
            let flightCode = "IT 720 (å»ç¨‹)";

            if (now > outboundDate && now < inboundDate) {
                flightStatus = "å›ç¨‹å€’æ•¸";
                targetDate = inboundDate;
                flightCode = "IT 721 (å›ç¨‹)";
            } else if (now > inboundDate) {
                flightStatus = "æ—…ç¨‹çµæŸ";
                targetDate = null;
            }

            const diff = targetDate ? targetDate - now : 0;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            const saveTitle = () => { localStorage.setItem('fukuoka_app_title', appTitle); setIsEditingTitle(false); };
            const saveLeader = () => { setLeaderInfo(tempLeader); setIsEditingLeader(false); };

            const fetchWeather = () => {
                setLoadingWeather(true);
                setWeatherError(null);
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const { latitude, longitude } = position.coords;
                        try {
                            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`);
                            const data = await res.json();
                            setWeather(data.current_weather);
                        } catch (e) { setWeatherError("å¤©æ°£ç²å–å¤±æ•—"); }
                        setLoadingWeather(false);
                    }, (err) => { 
                        console.log("Weather GPS Error:", err);
                        setWeatherError("ç„¡æ³•å®šä½ (è«‹åœ¨æ‰‹æ©Ÿé–‹å•ŸGPS)");
                        setLoadingWeather(false); 
                    });
                } else {
                    setWeatherError("ç€è¦½å™¨ä¸æ”¯æ´");
                    setLoadingWeather(false);
                }
            };

            return (
                <div className="h-full overflow-y-auto pb-24 bg-slate-50">
                    <div className="bg-slate-900 text-white p-6 rounded-b-[2.5rem] shadow-xl relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-blue-600 rounded-full blur-[80px] opacity-20 -mr-16 -mt-16"></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start">
                                <div className="inline-block px-3 py-1 bg-blue-900/50 rounded-full text-blue-300 text-xs font-bold mb-4 border border-blue-800">2024.12.09 - 12.15</div>
                                <button onClick={() => setIsEditingTitle(!isEditingTitle)} className="text-slate-400 hover:text-white"><Icon name="Edit" size={16}/></button>
                            </div>
                            {isEditingTitle ? (
                                <div className="flex gap-2">
                                    <input value={appTitle} onChange={(e) => setAppTitle(e.target.value)} className="text-slate-900 text-sm p-2 rounded flex-1"/>
                                    <button onClick={saveTitle} className="bg-blue-600 px-3 rounded text-xs font-bold">å„²å­˜</button>
                                </div>
                            ) : (
                                <h1 className="text-2xl font-black mb-1 tracking-tight leading-tight">{appTitle}</h1>
                            )}
                            <p className="text-slate-400 text-xs mt-1">Fukuoka Tactical Field Manual</p>
                        </div>
                    </div>

                    <div className="p-5 space-y-4 -mt-6 relative z-20">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <div className="flex justify-between items-start mb-3">
                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><Icon name="User" size={16} className="text-blue-600"/> é ˜éšŠè³‡è¨Š</h3>
                                <button onClick={() => isEditingLeader ? saveLeader() : setIsEditingLeader(true)} className="text-xs font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">{isEditingLeader ? 'å„²å­˜' : 'ç·¨è¼¯'}</button>
                            </div>
                            {isEditingLeader ? (
                                <div className="space-y-2">
                                    <input placeholder="é ˜éšŠå§“å" value={tempLeader.name} onChange={(e) => setTempLeader({...tempLeader, name: e.target.value})} className="w-full p-2 bg-slate-50 border rounded text-sm"/>
                                    <input placeholder="æ‰‹æ©Ÿ" value={tempLeader.phone} onChange={(e) => setTempLeader({...tempLeader, phone: e.target.value})} className="w-full p-2 bg-slate-50 border rounded text-sm"/>
                                    <input placeholder="Line ID" value={tempLeader.line} onChange={(e) => setTempLeader({...tempLeader, line: e.target.value})} className="w-full p-2 bg-slate-50 border rounded text-sm"/>
                                </div>
                            ) : (
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 font-bold text-xl">{leaderInfo.name ? leaderInfo.name[0] : <Icon name="User" size={24}/>}</div>
                                    <div>
                                        <div className="font-bold text-slate-800 text-lg">{leaderInfo.name || "æœªè¨­å®šé ˜éšŠ"}</div>
                                        <div className="text-xs text-slate-400 flex gap-2"><span>ğŸ“± {leaderInfo.phone || "--"}</span><span>ID: {leaderInfo.line || "--"}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {targetDate && (
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                                <div className="absolute right-0 top-0 w-20 h-20 bg-blue-50 rounded-bl-full -mr-4 -mt-4 z-0"></div>
                                <div className="relative z-10">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="p-2 bg-blue-100 text-blue-600 rounded-full"><Icon name="Train" size={18}/></div> 
                                        <div><div className="text-xs text-slate-400 font-bold uppercase">{flightStatus}</div><div className="font-black text-slate-800">{flightCode}</div></div>
                                    </div>
                                    <div className="flex justify-between items-end">
                                        <div className="text-3xl font-black text-blue-600 font-mono tracking-tighter">{days}<span className="text-sm text-slate-400 font-sans ml-1 mr-2">å¤©</span>{hours}<span className="text-sm text-slate-400 font-sans ml-1">æ™‚</span></div>
                                        <div className="text-xs text-slate-400 font-mono">{targetDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} èµ·é£›</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center">
                            <div>
                                <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-1"><Icon name="Sun" size={16} className="text-orange-500"/> ç¾åœ°æ°£å€™</h3>
                                {weather ? <div className="text-2xl font-black text-slate-800">{weather.temperature}Â°C</div> : <button onClick={fetchWeather} className="text-xs bg-slate-100 px-3 py-1.5 rounded-lg text-slate-500 font-bold mt-1">{loadingWeather ? "é€£ç·šä¸­..." : (weatherError || "é»æ­¤æŠ“å–ä½ç½®å¤©æ°£")}</button>}
                            </div>
                            {weather && <div className="text-right"><div className="text-xs text-slate-400">é¢¨é€Ÿ: {weather.windspeed} km/h</div><button onClick={fetchWeather} className="text-xs text-blue-500 mt-1">é‡æ–°æ•´ç†</button></div>}
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <button onClick={() => setActiveTab('itinerary')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2">
                                <div className="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><Icon name="Calendar" size={20} /></div>
                                <span className="font-bold text-slate-700 text-sm">è¡Œç¨‹è¡¨</span>
                            </button>
                            <button onClick={() => setActiveTab('map')} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center gap-2">
                                <div className="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center"><Icon name="Map" size={20} /></div>
                                <span className="font-bold text-slate-700 text-sm">å®šä½åœ°åœ–</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ToolboxTab = () => {
            const [jpy, setJpy] = useState('');
            const [rate, setRate] = useState(0.22);
            const [isAddressBig, setIsAddressBig] = useState(false);
            const [price, setPrice] = useState('');
            const [discount, setDiscount] = useState(10);
            const [coupon, setCoupon] = useState(5);

            const phrases = [
                { jp: "ã™ã¿ã¾ã›ã‚“", romaji: "Sumimasen", zh: "ä¸å¥½æ„æ€" },
                { jp: "ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Kore o onegaishimasu", zh: "æˆ‘è¦é€™å€‹" },
                { jp: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", romaji: "Okaikei o onegaishimasu", zh: "éº»ç…©çµå¸³" },
                { jp: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹", romaji: "Toire wa doko desu ka", zh: "å»æ‰€åœ¨å“ªè£¡" },
                { jp: "è¢‹ã¯ã„ã‚Šã¾ã›ã‚“", romaji: "Fukuro wa irimasen", zh: "ä¸ç”¨è¢‹å­" }
            ];

            const links = [
                { name: "Google Maps", url: "https://www.google.com/maps", icon: "MapPin", color: "text-red-500" },
                { name: "Tabelog (ç¾é£Ÿ)", url: "https://tabelog.com/", icon: "Utensils", color: "text-orange-500" },
                { name: "ãƒ­ã‚±ã‚¹ãƒ (æ‰¾åº—ç¥)", url: "https://www.locationsmart.org/", icon: "MapPin", color: "text-purple-500" },
                { name: "Yahoo! ä¹˜æ›æ¡ˆå…§", url: "https://transit.yahoo.co.jp/", icon: "Train", color: "text-green-600" }
            ];

            const finalPrice = price ? Math.round(price * (1 - (discount/100)) * (1 - (coupon/100))) : 0;
            const finalTwd = Math.round(finalPrice * rate);

            return (
                <div className="h-full overflow-y-auto p-4 space-y-6 pb-28 bg-slate-50">
                    <div className="grid grid-cols-2 gap-3">
                        {links.map((link, i) => (
                            <a key={i} href={link.url} target="_blank" rel="noopener noreferrer" className="bg-white p-3 rounded-xl shadow-sm border border-slate-200 flex items-center gap-3 hover:bg-slate-50 transition no-underline">
                                <div className={`p-2 bg-slate-50 rounded-full ${link.color}`}><Icon name={link.icon} size={18}/></div>
                                <span className="font-bold text-slate-700 text-sm">{link.name}</span>
                            </a>
                        ))}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-slate-800 text-white p-3 flex justify-between items-center">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="Car" size={18}/> é‹å°‡å¡</h3>
                            <button onClick={() => setIsAddressBig(!isAddressBig)} className="text-xs bg-white/20 px-2 py-1 rounded">{isAddressBig ? "ç¸®å°" : "æ”¾å¤§"}</button>
                        </div>
                        <div className={`p-5 flex flex-col justify-center items-center text-center transition-all ${isAddressBig ? "fixed inset-0 z-50 bg-white justify-center h-screen" : ""}`}>
                            {isAddressBig && <button onClick={() => setIsAddressBig(false)} className="absolute top-4 right-4 bg-slate-100 p-2 rounded-full"><Icon name="ChevronDown" size={24}/></button>}
                            <p className="text-slate-500 text-sm mb-2">è«‹è¼‰æˆ‘åˆ°é€™å®¶é£¯åº—ï¼š</p>
                            <h2 className={`font-black text-slate-900 leading-tight ${isAddressBig ? "text-4xl" : "text-xl"}`}>LIVEIL HAKATAEKIMAE</h2>
                            <p className={`mt-4 font-bold text-slate-800 bg-slate-100 p-4 rounded-xl ${isAddressBig ? "text-3xl" : "text-base"}`}>ã€’812-0011 ç¦å²¡å¸‚åšå¤šåŒº<br/>åšå¤šé§…å‰4ä¸ç›®31-11</p>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><Icon name="Percent" size={18} className="text-pink-500"/> æŠ˜æ‰£è¨ˆç®—æ©Ÿ</h3>
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            <div className="col-span-3"><input type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="åŸåƒ¹ (JPY)" className="w-full text-xl font-bold p-2 bg-slate-50 rounded-lg border border-slate-200"/></div>
                            <div><input type="number" value={discount} onChange={e => setDiscount(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg text-center" placeholder="å…ç¨…%"/></div>
                            <div><input type="number" value={coupon} onChange={e => setCoupon(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg text-center" placeholder="å„ªæƒ %"/></div>
                            <div><input type="number" value={rate} step="0.001" onChange={e => setRate(e.target.value)} className="w-full p-2 bg-slate-50 border rounded-lg text-center"/></div>
                        </div>
                        <div className="bg-slate-800 text-white p-3 rounded-xl flex justify-between items-center">
                            <span className="text-xs opacity-70">æŠ˜å¾Œå°å¹£</span><span className="text-2xl font-bold">NT$ {finalTwd.toLocaleString()}</span>
                        </div>
                    </div>

                    {/* Restored Simple Currency Converter */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-4">
                        <h3 className="font-bold text-slate-800 flex items-center gap-2 mb-4"><Icon name="DollarSign" size={18} className="text-green-600"/> ç°¡æ˜“åŒ¯ç‡æ›ç®—</h3>
                        <div className="flex gap-2 items-center">
                            <div className="flex-1">
                                <input 
                                    type="number" 
                                    value={jpy}
                                    onChange={(e) => setJpy(e.target.value)}
                                    placeholder="æ—¥å¹£"
                                    className="w-full text-lg font-bold p-2 bg-slate-50 rounded-lg border border-slate-200 outline-none"
                                />
                            </div>
                            <Icon name="Refresh" size={20} className="text-slate-300"/>
                            <div className="flex-1">
                                <div className="w-full text-lg font-bold p-2 text-slate-800 bg-slate-50 rounded-lg border border-transparent">
                                    NT$ {jpy ? Math.round(jpy * rate).toLocaleString() : "0"}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Restored Survival Japanese */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-orange-50 p-3 border-b border-orange-100">
                            <h3 className="font-bold text-orange-800 flex items-center gap-2"><Icon name="Type" size={18}/> ç”Ÿå­˜æ—¥èª</h3>
                        </div>
                        <div className="divide-y divide-slate-100">
                            {phrases.map((p, i) => (
                                <div key={i} className="p-3 hover:bg-slate-50 transition">
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="font-bold text-slate-800">{p.zh}</span>
                                        <span className="text-xs text-slate-400 font-mono">{p.romaji}</span>
                                    </div>
                                    <div className="text-lg text-blue-600 font-bold">{p.jp}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseTracker = () => {
            const [expenses, setExpenses] = useState(() => {
                const saved = localStorage.getItem('fukuoka_expenses');
                return saved ? JSON.parse(saved) : [{ id: 1, item: 'è¨ˆç¨‹è»Š', amount: 2500, cat: 'transport' }];
            });
            const [newItem, setNewItem] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [newCat, setNewCat] = useState('food');

            useEffect(() => { localStorage.setItem('fukuoka_expenses', JSON.stringify(expenses)); }, [expenses]);

            const addExpense = () => {
                if (!newItem || !newAmount) return;
                setExpenses([...expenses, { id: Date.now(), item: newItem, amount: parseInt(newAmount), cat: newCat }]);
                setNewItem('');
                setNewAmount('');
            };

            const deleteExpense = (id) => {
                if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) setExpenses(prev => prev.filter(item => item.id !== id));
            };

            const total = expenses.reduce((sum, ex) => sum + ex.amount, 0);

            return (
                <div className="p-4 space-y-6 bg-slate-50 h-full overflow-y-auto">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div className="text-slate-500 text-sm mb-1">ç¸½æ”¯å‡º (æ—¥åœ“)</div>
                        <div className="text-4xl font-bold text-slate-800">Â¥ {total.toLocaleString()}</div>
                    </div>
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 space-y-3">
                        <div className="grid grid-cols-2 gap-2">
                            <input placeholder="é …ç›®" className="col-span-2 p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm" value={newItem} onChange={e => setNewItem(e.target.value)} />
                            <input type="number" placeholder="é‡‘é¡" className="p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm" value={newAmount} onChange={e => setNewAmount(e.target.value)} />
                            <select className="p-2 bg-slate-50 rounded-lg border border-slate-200 text-sm" value={newCat} onChange={e => setNewCat(e.target.value)}>
                                <option value="food">é¤é£²</option><option value="transport">äº¤é€š</option><option value="shopping">è³¼ç‰©</option><option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <button onClick={addExpense} className="w-full bg-slate-800 text-white py-2 rounded-lg font-medium text-sm active:scale-95 transition">ç´€éŒ„</button>
                    </div>
                    <div className="space-y-2 pb-20">
                        {expenses.slice().reverse().map(ex => (
                            <div key={ex.id} className="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100">
                                <div className="flex items-center gap-3">
                                    <div className={`p-2 rounded-full ${ex.cat === 'food' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100'}`}><Icon name={ex.cat === 'food' ? 'Utensils' : 'CreditCard'} size={16}/></div>
                                    <div><div className="text-sm font-medium">{ex.item}</div></div>
                                </div>
                                <div className="flex items-center gap-2"><span className="font-bold">Â¥{ex.amount}</span><button onClick={() => deleteExpense(ex.id)}><Icon name="Trash2" size={16} className="text-slate-300"/></button></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ItineraryDay = ({ dayData, onDeleteTask, onAddTask }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [isAdding, setIsAdding] = useState(false);
            const [newTask, setNewTask] = useState({ time: '', title: '', type: 'sightseeing' });

            useEffect(() => { if (dayData.day === 1) setIsOpen(true); }, [dayData.day]);

            const handleSave = () => {
                if (!newTask.title) return;
                onAddTask(dayData.day, { ...newTask, id: 't' + Date.now() });
                setIsAdding(false);
            };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div onClick={() => setIsOpen(!isOpen)} className="p-4 flex items-center justify-between cursor-pointer bg-slate-50 hover:bg-slate-100">
                        <div className="flex items-center gap-4">
                            <div className="bg-slate-800 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold text-lg">{dayData.day}</div>
                            <div><div className="text-xs text-slate-500 font-medium">{dayData.date}</div><div className="text-slate-800 font-bold">{dayData.theme}</div></div>
                        </div>
                        <Icon name={isOpen ? "ChevronUp" : "ChevronDown"} className="text-slate-400" />
                    </div>
                    {isOpen && (
                        <div className="p-4 space-y-4 border-t border-slate-100">
                            {dayData.tasks.map((task) => (
                                <div key={task.id} className="flex gap-3">
                                    <div className="mt-1 min-w-[40px] h-[40px] rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><Icon name="MapPin" size={18}/></div>
                                    <div className="flex-1">
                                        <div className="flex justify-between">
                                            <div><span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded mr-2">{task.time}</span><span className="font-bold text-slate-800">{task.title}</span></div>
                                            <button onClick={() => onDeleteTask(dayData.day, task.id)} className="text-slate-300"><Icon name="Trash2" size={16}/></button>
                                        </div>
                                        <div className="text-sm text-slate-500 mt-1 leading-relaxed">{task.note}</div>
                                        {task.map && <a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(task.map + " Fukuoka")}`} target="_blank" className="text-xs text-blue-500 mt-1 block">å°èˆª ></a>}
                                    </div>
                                </div>
                            ))}
                            {!isAdding ? <button onClick={() => setIsAdding(true)} className="w-full py-2 bg-slate-50 text-slate-500 rounded text-sm font-bold">+ æ–°å¢</button> : 
                            <div className="bg-slate-50 p-3 rounded space-y-2">
                                <input placeholder="æ™‚é–“" className="w-full p-2 text-sm border rounded" value={newTask.time} onChange={e => setNewTask({...newTask, time: e.target.value})}/>
                                <input placeholder="æ¨™é¡Œ" className="w-full p-2 text-sm border rounded" value={newTask.title} onChange={e => setNewTask({...newTask, title: e.target.value})}/>
                                <div className="flex gap-2"><button onClick={() => setIsAdding(false)} className="flex-1 bg-white p-2 text-sm border rounded">å–æ¶ˆ</button><button onClick={handleSave} className="flex-1 bg-blue-600 text-white p-2 text-sm rounded">å„²å­˜</button></div>
                            </div>}
                        </div>
                    )}
                </div>
            );
        };

        const ChecklistTab = ({ items, toggleItem }) => {
            return (
                <div className="h-full overflow-y-auto p-4 space-y-4">
                    <div className="bg-slate-800 text-white p-6 rounded-2xl shadow-md">
                        <h2 className="text-xl font-bold">å‡ºæ“Šæ¸…å–®</h2>
                        <div className="mt-2 text-2xl font-bold">{items.filter(i => i.done).length} / {items.length}</div>
                    </div>
                    <div className="bg-white rounded-xl border border-slate-200 divide-y divide-slate-100">
                        {items.map(item => (
                            <div key={item.id} onClick={() => toggleItem(item.id)} className="p-4 flex items-center gap-3 cursor-pointer">
                                <div className={`w-6 h-6 rounded border-2 flex items-center justify-center ${item.done ? 'bg-blue-600 border-blue-600' : 'border-slate-300'}`}>{item.done && <Icon name="CheckSquare" size={16} className="text-white"/>}</div>
                                <span className={item.done ? 'text-slate-400 line-through' : 'text-slate-800'}>{item.text}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [itinerary, setItinerary] = useState(() => JSON.parse(localStorage.getItem('fukuoka_itinerary')) || initialTripData.itinerary);
            const [checklist, setChecklist] = useState(() => JSON.parse(localStorage.getItem('fukuoka_checklist')) || initialChecklist);
            const [leaderInfo, setLeaderInfo] = useState(() => JSON.parse(localStorage.getItem('fukuoka_leader')) || { name: '', phone: '', line: '' });

            useEffect(() => { localStorage.setItem('fukuoka_itinerary', JSON.stringify(itinerary)); }, [itinerary]);
            useEffect(() => { localStorage.setItem('fukuoka_checklist', JSON.stringify(checklist)); }, [checklist]);
            useEffect(() => { localStorage.setItem('fukuoka_leader', JSON.stringify(leaderInfo)); }, [leaderInfo]);

            const handleDeleteTask = (dayNum, taskId) => {
                if (window.confirm("åˆªé™¤ï¼Ÿ")) setItinerary(prev => prev.map(d => d.day === dayNum ? { ...d, tasks: d.tasks.filter(t => t.id !== taskId) } : d));
            };
            const handleAddTask = (dayNum, newTask) => {
                setItinerary(prev => prev.map(d => d.day === dayNum ? { ...d, tasks: [...d.tasks, newTask].sort((a,b)=>a.time.localeCompare(b.time)) } : d));
            };
            const toggleChecklist = (id) => setChecklist(prev => prev.map(i => i.id === id ? { ...i, done: !i.done } : i));

            return (
                <div className="flex flex-col h-full font-sans text-slate-900">
                    <div className="flex-1 overflow-hidden relative">
                        {activeTab === 'home' && <HomeTab leaderInfo={leaderInfo} setLeaderInfo={setLeaderInfo} setActiveTab={setActiveTab} />}
                        {activeTab === 'itinerary' && <div className="h-full overflow-y-auto p-4 space-y-4 pb-32">{itinerary.map(day => <ItineraryDay key={day.day} dayData={day} onDeleteTask={handleDeleteTask} onAddTask={handleAddTask} />)}</div>}
                        {activeTab === 'map' && <MapTab itinerary={itinerary} />}
                        {activeTab === 'wallet' && <ExpenseTracker />}
                        {activeTab === 'tools' && <ToolboxTab />}
                        {activeTab === 'checklist' && <ChecklistTab items={checklist} toggleItem={toggleChecklist} />}
                    </div>
                    <div className="fixed bottom-6 left-4 right-4 bg-white/95 backdrop-blur-md border border-slate-200 rounded-2xl shadow-2xl px-4 py-3 flex justify-between items-center z-50">
                        <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center gap-1 ${activeTab === 'home' ? 'text-blue-600 scale-110' : 'text-slate-400'}`}><Icon name="Home" size={24}/><span className="text-[10px] font-bold">é¦–é </span></button>
                        <button onClick={() => setActiveTab('itinerary')} className={`flex flex-col items-center gap-1 ${activeTab === 'itinerary' ? 'text-blue-600 scale-110' : 'text-slate-400'}`}><Icon name="Calendar" size={24}/><span className="text-[10px] font-bold">è¡Œç¨‹</span></button>
                        <button onClick={() => setActiveTab('map')} className={`flex flex-col items-center gap-1 ${activeTab === 'map' ? 'text-blue-600 scale-110' : 'text-slate-400'}`}><Icon name="Map" size={24}/><span className="text-[10px] font-bold">åœ°åœ–</span></button>
                        <button onClick={() => setActiveTab('wallet')} className={`flex flex-col items-center gap-1 ${activeTab === 'wallet' ? 'text-blue-600 scale-110' : 'text-slate-400'}`}><Icon name="CreditCard" size={24}/><span className="text-[10px] font-bold">éŒ¢åŒ…</span></button>
                        <button onClick={() => setActiveTab('tools')} className={`flex flex-col items-center gap-1 ${activeTab === 'tools' ? 'text-blue-600 scale-110' : 'text-slate-400'}`}><Icon name="Briefcase" size={24}/><span className="text-[10px] font-bold">å·¥å…·</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>